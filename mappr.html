<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Scale up evaluation report mapping against evaluation frameworks using agentic workflows">

<title>Mappr – Evaluatr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-738cac9e5f2ad4ecce05fe3ba55cd681.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Mappr – Evaluatr">
<meta property="og:description" content="Scale up evaluation report mapping against evaluation frameworks using agentic workflows">
<meta property="og:image" content="https://franckalbinet.github.io/evaluatr/img/three-stage-pipeline-overview.png">
<meta property="og:site_name" content="Evaluatr">
<meta property="og:image:height" content="741">
<meta property="og:image:width" content="871">
<meta name="twitter:title" content="Mappr – Evaluatr">
<meta name="twitter:description" content="Scale up evaluation report mapping against evaluation frameworks using agentic workflows">
<meta name="twitter:image" content="https://franckalbinet.github.io/evaluatr/img/three-stage-pipeline-overview.png">
<meta name="twitter:image-height" content="741">
<meta name="twitter:image-width" content="871">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Evaluatr</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/franckalbinet/evaluatr"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./readers.html">API</a></li><li class="breadcrumb-item"><a href="./mappr.html">Mappr</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluatr</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorials/eval_reports_eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluation reports EDA</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">API</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./readers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Readers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./downloaders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Downloaders</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ocr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OCR</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./enrichr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Enrichr</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./frameworks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Frameworks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mappr.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Mappr</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#db-cache-setup" id="toc-db-cache-setup" class="nav-link active" data-scroll-target="#db-cache-setup">DB cache setup</a>
  <ul>
  <li><a href="#sectionscache" id="toc-sectionscache" class="nav-link" data-scroll-target="#sectionscache">SectionsCache</a></li>
  <li><a href="#themetaggingcache" id="toc-themetaggingcache" class="nav-link" data-scroll-target="#themetaggingcache">ThemeTaggingCache</a></li>
  </ul></li>
  <li><a href="#report-loading" id="toc-report-loading" class="nav-link" data-scroll-target="#report-loading">Report loading</a>
  <ul>
  <li><a href="#load_report" id="toc-load_report" class="nav-link" data-scroll-target="#load_report">load_report</a></li>
  </ul></li>
  <li><a href="#hierarchical-report-navigation" id="toc-hierarchical-report-navigation" class="nav-link" data-scroll-target="#hierarchical-report-navigation">Hierarchical report navigation</a>
  <ul>
  <li><a href="#find_section_path" id="toc-find_section_path" class="nav-link" data-scroll-target="#find_section_path">find_section_path</a></li>
  <li><a href="#get_content_tool" id="toc-get_content_tool" class="nav-link" data-scroll-target="#get_content_tool">get_content_tool</a></li>
  <li><a href="#flatten_sections" id="toc-flatten_sections" class="nav-link" data-scroll-target="#flatten_sections">flatten_sections</a></li>
  <li><a href="#format_toc_for_llm" id="toc-format_toc_for_llm" class="nav-link" data-scroll-target="#format_toc_for_llm">format_toc_for_llm</a></li>
  </ul></li>
  <li><a href="#formatters" id="toc-formatters" class="nav-link" data-scroll-target="#formatters">Formatters</a>
  <ul>
  <li><a href="#format_enabler_theme" id="toc-format_enabler_theme" class="nav-link" data-scroll-target="#format_enabler_theme">format_enabler_theme</a></li>
  <li><a href="#format_crosscutting_theme" id="toc-format_crosscutting_theme" class="nav-link" data-scroll-target="#format_crosscutting_theme">format_crosscutting_theme</a></li>
  <li><a href="#format_gcm_theme" id="toc-format_gcm_theme" class="nav-link" data-scroll-target="#format_gcm_theme">format_gcm_theme</a></li>
  <li><a href="#format_srf_output" id="toc-format_srf_output" class="nav-link" data-scroll-target="#format_srf_output">format_srf_output</a></li>
  </ul></li>
  <li><a href="#pydantic-models" id="toc-pydantic-models" class="nav-link" data-scroll-target="#pydantic-models">Pydantic models</a>
  <ul>
  <li><a href="#coresectionsoutput" id="toc-coresectionsoutput" class="nav-link" data-scroll-target="#coresectionsoutput">CoreSectionsOutput</a></li>
  <li><a href="#evidencelocation" id="toc-evidencelocation" class="nav-link" data-scroll-target="#evidencelocation">EvidenceLocation</a></li>
  <li><a href="#themetaggingoutput" id="toc-themetaggingoutput" class="nav-link" data-scroll-target="#themetaggingoutput">ThemeTaggingOutput</a></li>
  </ul></li>
  <li><a href="#system-prompts" id="toc-system-prompts" class="nav-link" data-scroll-target="#system-prompts">System prompts</a></li>
  <li><a href="#theme-analysis-core-steps" id="toc-theme-analysis-core-steps" class="nav-link" data-scroll-target="#theme-analysis-core-steps">Theme analysis core steps</a>
  <ul>
  <li><a href="#parse_response" id="toc-parse_response" class="nav-link" data-scroll-target="#parse_response">parse_response</a></li>
  <li><a href="#select-sections-of-interest" id="toc-select-sections-of-interest" class="nav-link" data-scroll-target="#select-sections-of-interest">Select sections of interest</a></li>
  <li><a href="#identify_core_sections" id="toc-identify_core_sections" class="nav-link" data-scroll-target="#identify_core_sections">identify_core_sections</a></li>
  <li><a href="#extract_core_content" id="toc-extract_core_content" class="nav-link" data-scroll-target="#extract_core_content">extract_core_content</a></li>
  <li><a href="#tagging" id="toc-tagging" class="nav-link" data-scroll-target="#tagging">Tagging</a></li>
  <li><a href="#tagresult" id="toc-tagresult" class="nav-link" data-scroll-target="#tagresult">TagResult</a></li>
  <li><a href="#tag_theme" id="toc-tag_theme" class="nav-link" data-scroll-target="#tag_theme">tag_theme</a></li>
  </ul></li>
  <li><a href="#logging" id="toc-logging" class="nav-link" data-scroll-target="#logging">Logging</a>
  <ul>
  <li><a href="#stage" id="toc-stage" class="nav-link" data-scroll-target="#stage">Stage</a></li>
  <li><a href="#tracecontext" id="toc-tracecontext" class="nav-link" data-scroll-target="#tracecontext">TraceContext</a></li>
  <li><a href="#setup_logger" id="toc-setup_logger" class="nav-link" data-scroll-target="#setup_logger">setup_logger</a></li>
  <li><a href="#setup_trace_logging" id="toc-setup_trace_logging" class="nav-link" data-scroll-target="#setup_trace_logging">setup_trace_logging</a></li>
  <li><a href="#log_analysis_event" id="toc-log_analysis_event" class="nav-link" data-scroll-target="#log_analysis_event">log_analysis_event</a></li>
  </ul></li>
  <li><a href="#pipeline-orchestrator" id="toc-pipeline-orchestrator" class="nav-link" data-scroll-target="#pipeline-orchestrator">Pipeline Orchestrator</a>
  <ul>
  <li><a href="#get_from_cache" id="toc-get_from_cache" class="nav-link" data-scroll-target="#get_from_cache">get_from_cache</a></li>
  <li><a href="#store_in_cache" id="toc-store_in_cache" class="nav-link" data-scroll-target="#store_in_cache">store_in_cache</a></li>
  <li><a href="#limit" id="toc-limit" class="nav-link" data-scroll-target="#limit">limit</a></li>
  <li><a href="#taggingresult" id="toc-taggingresult" class="nav-link" data-scroll-target="#taggingresult">TaggingResult</a></li>
  <li><a href="#pipelineresults" id="toc-pipelineresults" class="nav-link" data-scroll-target="#pipelineresults">PipelineResults</a></li>
  <li><a href="#pipelineresults.__call__" id="toc-pipelineresults.__call__" class="nav-link" data-scroll-target="#pipelineresults.__call__">PipelineResults.__call__</a></li>
  <li><a href="#pipelineorchestrator" id="toc-pipelineorchestrator" class="nav-link" data-scroll-target="#pipelineorchestrator">PipelineOrchestrator</a></li>
  <li><a href="#pipelineorchestrator.identify_sections" id="toc-pipelineorchestrator.identify_sections" class="nav-link" data-scroll-target="#pipelineorchestrator.identify_sections">PipelineOrchestrator.identify_sections</a></li>
  <li><a href="#pipelineorchestrator.process_themes_batch" id="toc-pipelineorchestrator.process_themes_batch" class="nav-link" data-scroll-target="#pipelineorchestrator.process_themes_batch">PipelineOrchestrator.process_themes_batch</a></li>
  <li><a href="#pipelineorchestrator.run_stage1" id="toc-pipelineorchestrator.run_stage1" class="nav-link" data-scroll-target="#pipelineorchestrator.run_stage1">PipelineOrchestrator.run_stage1</a></li>
  <li><a href="#pipelineorchestrator.get_stage1_context" id="toc-pipelineorchestrator.get_stage1_context" class="nav-link" data-scroll-target="#pipelineorchestrator.get_stage1_context">PipelineOrchestrator.get_stage1_context</a></li>
  <li><a href="#pipelineorchestrator.run_stage2" id="toc-pipelineorchestrator.run_stage2" class="nav-link" data-scroll-target="#pipelineorchestrator.run_stage2">PipelineOrchestrator.run_stage2</a></li>
  <li><a href="#filtering-out-srf-outputs" id="toc-filtering-out-srf-outputs" class="nav-link" data-scroll-target="#filtering-out-srf-outputs">Filtering out SRF outputs</a></li>
  <li><a href="#get_filtered_srf_output_ids" id="toc-get_filtered_srf_output_ids" class="nav-link" data-scroll-target="#get_filtered_srf_output_ids">get_filtered_srf_output_ids</a></li>
  <li><a href="#pipelineorchestrator.get_combined_context" id="toc-pipelineorchestrator.get_combined_context" class="nav-link" data-scroll-target="#pipelineorchestrator.get_combined_context">PipelineOrchestrator.get_combined_context</a></li>
  <li><a href="#pipelineorchestrator.get_filtered_srf_outputs" id="toc-pipelineorchestrator.get_filtered_srf_outputs" class="nav-link" data-scroll-target="#pipelineorchestrator.get_filtered_srf_outputs">PipelineOrchestrator.get_filtered_srf_outputs</a></li>
  <li><a href="#pipelineorchestrator.run_stage3" id="toc-pipelineorchestrator.run_stage3" class="nav-link" data-scroll-target="#pipelineorchestrator.run_stage3">PipelineOrchestrator.run_stage3</a></li>
  </ul></li>
  <li><a href="#cli" id="toc-cli" class="nav-link" data-scroll-target="#cli">CLI</a>
  <ul>
  <li><a href="#find_enriched_path" id="toc-find_enriched_path" class="nav-link" data-scroll-target="#find_enriched_path">find_enriched_path</a></li>
  <li><a href="#parse_force_refresh" id="toc-parse_force_refresh" class="nav-link" data-scroll-target="#parse_force_refresh">parse_force_refresh</a></li>
  <li><a href="#run_selected_stages" id="toc-run_selected_stages" class="nav-link" data-scroll-target="#run_selected_stages">run_selected_stages</a></li>
  <li><a href="#tag_evaluation" id="toc-tag_evaluation" class="nav-link" data-scroll-target="#tag_evaluation">tag_evaluation</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/franckalbinet/evaluatr/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./readers.html">API</a></li><li class="breadcrumb-item"><a href="./mappr.html">Mappr</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Mappr</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>

<div>
  <div class="description">
    Scale up evaluation report mapping against evaluation frameworks using agentic workflows
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This notebook is a work in progress.</p>
</div>
</div>
<p>Manually mapping evaluation reports against IOM’s <a href="https://srf.iom.int">Strategic Results Framework (SRF)</a> is time-consuming and resource-intensive with ~150 outputs to analyze. Additionally, the mapping process needs transparent and human-readable traces of LLM decision flows that both reflect natural reasoning patterns and allow human evaluators to audit the mapping logic.</p>
<p>A three-stage async pipeline leveraging <a href="https://www.un.org/en/development/desa/population/migration/generalassembly/docs/globalcompact/A_RES_73_195.pdf">Global Compact for Migration (GCM) UN General Assembly Resolution</a> objectives as SRF Outputs pruning mechanism:</p>
<p><strong>Stage 1</strong>: SRF Enablers &amp; Cross-cutting Analysis</p>
<ul>
<li><strong>Async parallel analysis</strong> of Enablers (7 categories) and Cross-cutting Priorities (4 categories) using shared semaphore for rate limiting</li>
<li><strong>Purpose</strong>: Identify if report is primarily meta-evaluation/transversal in nature</li>
<li><strong>Fast processing</strong>: ~11 items total with concurrent execution, provides context for subsequent stages</li>
</ul>
<p><strong>Stage 2</strong>: Informed GCM Analysis</p>
<ul>
<li><strong>Rate-limited parallel processing</strong> of GCM Objectives (23 items) informed by Stage 1 results</li>
<li><strong>Condensed representations</strong>: UN General Assembly Resolution formulation simplified for retrieval efficiency</li>
<li><strong>Concurrent theme analysis</strong> with API quota management</li>
</ul>
<p><strong>Stage 3</strong>: Targeted SRF Analysis</p>
<ul>
<li><strong>SRF Filtering</strong>: Use GCM results + <code>gcm_srf_lut</code> lookup table to prune ~150 SRF outputs to ~20-50 relevant ones</li>
<li><strong>Deep parallel analysis</strong>: Full hierarchy context (objective → outcome → output → indicators)</li>
<li><strong>Async batch processing</strong>: Final targeted analysis of pruned SRF outputs with retry logic and error handling</li>
</ul>
<div class="page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="img/three-stage-pipeline-overview.png" class="img-fluid figure-img column-body" width="800"></p>
<figcaption>Three-stage Pipeline Overview</figcaption>
</figure>
</div>
</div>
<div id="cell-5" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> toolslm.md_hier <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Callable</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copy <span class="im">import</span> deepcopy</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> asyncio <span class="im">import</span> Semaphore, gather, sleep</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> evaluatr.frameworks <span class="im">import</span> (EvalData, </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>                                 IOMEvalData, </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>                                 FrameworkInfo, </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>                                 Framework,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>                                 FrameworkCat,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>                                 find_srf_output_by_id)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastlite <span class="im">import</span> Database</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> apswutils.db <span class="im">import</span> NotFoundError</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lisette <span class="im">import</span> mk_msg, AsyncChat</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lisette.core <span class="im">import</span> acompletion</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-6" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>GEMINI_API_KEY <span class="op">=</span> os.getenv(<span class="st">'GEMINI_API_KEY'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-7" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> AttrDict({</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'lm'</span>: <span class="st">'gemini/gemini-2.0-flash'</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'api_key'</span>: GEMINI_API_KEY,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_tokens'</span>: <span class="dv">8192</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'track_usage'</span>: <span class="va">False</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'call_delay'</span>: <span class="fl">0.1</span>, <span class="co"># in seconds</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'semaphore'</span>: <span class="dv">2</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dirs'</span>: AttrDict({</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'data'</span>: <span class="st">'.evaluatr'</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'trace'</span>: <span class="st">'traces'</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    }),</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'verbosity'</span>: <span class="dv">1</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cache'</span>: AttrDict({</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'db_name'</span>:  <span class="st">'pipeline_cache.db'</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    }),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-8" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>traces_dir <span class="op">=</span> Path.home() <span class="op">/</span> cfg.dirs.data <span class="op">/</span> cfg.dirs.trace</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>traces_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="db-cache-setup" class="level2">
<h2 class="anchored" data-anchor-id="db-cache-setup">DB cache setup</h2>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L87" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="sectionscache" class="level3">
<h3 class="anchored" data-anchor-id="sectionscache">SectionsCache</h3>
<blockquote class="blockquote">
<pre><code> SectionsCache (report_id:str, sections_selected:str, reasoning:str,
                timestamp:str=None)</code></pre>
</blockquote>
<div id="cell-11" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>db_path <span class="op">=</span> traces_dir <span class="op">/</span> cfg.cache.db_name</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(db_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-12" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SectionsCache:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    report_id: <span class="bu">str</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    sections_selected: <span class="bu">str</span>  <span class="co"># JSON list</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    reasoning: <span class="bu">str</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    timestamp: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L95" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="themetaggingcache" class="level3">
<h3 class="anchored" data-anchor-id="themetaggingcache">ThemeTaggingCache</h3>
<blockquote class="blockquote">
<pre><code> ThemeTaggingCache (report_id:str, stage:str, framework:str,
                    framework_category:str, framework_theme_id:str,
                    is_core:bool, reasoning:str, confidence:str,
                    timestamp:str=None)</code></pre>
</blockquote>
<div id="cell-14" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemeTaggingCache:</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    report_id: <span class="bu">str</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    stage: <span class="bu">str</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    framework: <span class="bu">str</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    framework_category: <span class="bu">str</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    framework_theme_id: <span class="bu">str</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    is_core: <span class="bu">bool</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    reasoning: <span class="bu">str</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    confidence: <span class="bu">str</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    timestamp: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-15" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sections_cache <span class="op">=</span> db.create(SectionsCache, pk<span class="op">=</span><span class="st">'report_id'</span>, ignore<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>theme_cache <span class="op">=</span> db.create(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    ThemeTaggingCache, </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    pk<span class="op">=</span>[<span class="st">'report_id'</span>, <span class="st">'stage'</span>, <span class="st">'framework'</span>, <span class="st">'framework_category'</span>, <span class="st">'framework_theme_id'</span>],</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    ignore<span class="op">=</span><span class="va">True</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="report-loading" class="level2">
<h2 class="anchored" data-anchor-id="report-loading">Report loading</h2>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L115" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="load_report" class="level3">
<h3 class="anchored" data-anchor-id="load_report">load_report</h3>
<blockquote class="blockquote">
<pre><code> load_report (doc_path:str)</code></pre>
</blockquote>
<p><em>Read evaluation report from enriched markdown pages</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>doc_path</td>
<td>str</td>
<td>Path to the evaluation report</td>
</tr>
</tbody>
</table>
<div id="cell-18" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_report(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    doc_path:<span class="bu">str</span> <span class="co"># Path to the evaluation report</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Read evaluation report from enriched markdown pages"</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> Path(doc_path)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    pages <span class="op">=</span> doc.ls(file_exts<span class="op">=</span><span class="st">".md"</span>).<span class="bu">sorted</span>(key<span class="op">=</span><span class="kw">lambda</span> p: <span class="bu">int</span>(p.stem.split(<span class="st">'_'</span>)[<span class="dv">1</span>]))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    report <span class="op">=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">---</span><span class="ch">\n\n</span><span class="st">'</span>.join(page.read_text() <span class="cf">for</span> page <span class="kw">in</span> pages)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> report</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-19" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># "abridged_evaluation_report_final_olta_ndoja_pdf/enriched" (shorter version for testing)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>doc_path <span class="op">=</span> <span class="st">"../_data/md_library/49d2fba781b6a7c0d94577479636ee6f/final_evaluation_report_final_olta_ndoja_pdf/enriched"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>doc_path <span class="op">=</span> <span class="st">"../_data/md_library/evaluation-of-iom-accountability-tmp/aap_evaluation_report_final_pdf/enriched"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>doc_path <span class="op">=</span> <span class="st">"../_data/md_library/evaluation-of-iom-accountability-tmp/final_evaluation_report_final_pdf/enriched"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>doc_path <span class="op">=</span> <span class="st">"../_data/md_library/22cac1c000836253adc445993e101560/final_report_evaluation_of_mhpss_in_iom_8_2024_pdf/enriched"</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>report <span class="op">=</span> load_report(doc_path)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(report[:<span class="dv">1000</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">!<span style="font-weight: bold">(</span>img-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.j</span>peg<span style="font-weight: bold">)</span>

# Evaluation of Mental Health and Psychosocial Support in IOM <span style="color: #808000; text-decoration-color: #808000">...</span>. page <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>

IOM CENTRAL EVALUATION

August <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>

---

# ACKNOWLEDGEMENTS <span style="color: #808000; text-decoration-color: #808000">...</span>. page <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>

The evaluation was undertaken by external consultants of Peace in Practice consultancy, on behalf of the Central 
Evaluation Division <span style="font-weight: bold">(</span>CED<span style="font-weight: bold">)</span>. The team was composed of Dr. Leslie Snider <span style="font-weight: bold">(</span>lead<span style="font-weight: bold">)</span> and Dr. Carolina Herbert.

The consultants would like to extend their sincere thanks to all those who gave their time and input to the 
evaluation, including the representatives of Member States, UN agencies, international NGOs, academia and other 
external stakeholders, and IOM staff and managers at all levels of the Organization. Special appreciation is 
extended to IOM MHPSS staff and managers for their thoughtful reflections, and to the contributors for the case 
studies from IOM MHPSS country and regional offices in Ukraine, Poland, West and Central Africa, and Colombia. 
Finally, the consultants are grateful for the unwaverin
</pre>
</div>
</div>
</section>
</section>
<section id="hierarchical-report-navigation" class="level2">
<h2 class="anchored" data-anchor-id="hierarchical-report-navigation">Hierarchical report navigation</h2>
<p>Thanks to <code>toolslm.md_hier</code> and a clean markdown structure of a <code>report</code> markdown, we can create a nested dictionary of section, subsection, … as follows:</p>
<div id="cell-22" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>hdgs <span class="op">=</span> create_heading_dict(report)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L125" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="find_section_path" class="level3">
<h3 class="anchored" data-anchor-id="find_section_path">find_section_path</h3>
<blockquote class="blockquote">
<pre><code> find_section_path (hdgs:dict, target_section:str)</code></pre>
</blockquote>
<p><em>Find the nested key path for a given section name.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>hdgs</td>
<td>dict</td>
<td>The nested dictionary structure</td>
</tr>
<tr class="even">
<td>target_section</td>
<td>str</td>
<td>The section name to find</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>list</strong></td>
<td><strong>The nested key path for the given section name</strong></td>
</tr>
</tbody>
</table>
<div id="cell-24" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_section_path(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    hdgs: <span class="bu">dict</span>, <span class="co"># The nested dictionary structure</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    target_section: <span class="bu">str</span> <span class="co"># The section name to find</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">list</span>: <span class="co"># The nested key path for the given section name</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Find the nested key path for a given section name."</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> search_recursive(current_dict, path<span class="op">=</span>[]):</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> current_dict.items():</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>            current_path <span class="op">=</span> path <span class="op">+</span> [key]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="op">==</span> target_section:</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> current_path</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">dict</span>):</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> search_recursive(value, current_path)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> result:</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> result</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> search_recursive(hdgs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Then we can retrieve the subsection path (list of nested headings to reach this specific section) in this nested <code>hdgs</code> dict :</p>
<div id="cell-26" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> find_section_path(hdgs, <span class="st">"Executive summary .... page 10"</span>)<span class="op">;</span> path</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Then retrieve the specific subsection content:</p>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L144" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_content_tool" class="level3">
<h3 class="anchored" data-anchor-id="get_content_tool">get_content_tool</h3>
<blockquote class="blockquote">
<pre><code> get_content_tool (hdgs:dict, keys_list:list)</code></pre>
</blockquote>
<p><em>Navigate through nested levels using the exact key strings.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>hdgs</td>
<td>dict</td>
<td>The nested dictionary structure</td>
</tr>
<tr class="even">
<td>keys_list</td>
<td>list</td>
<td>The list of keys to navigate through</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td><strong>The content of the section</strong></td>
</tr>
</tbody>
</table>
<div id="cell-29" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_content_tool(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    hdgs: <span class="bu">dict</span>, <span class="co"># The nested dictionary structure</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    keys_list: <span class="bu">list</span>, <span class="co"># The list of keys to navigate through</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">str</span>: <span class="co"># The content of the section</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Navigate through nested levels using the exact key strings."</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> current, key: current[key], keys_list, hdgs).text</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-30" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>content <span class="op">=</span> get_content_tool(hdgs, path)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(content[:<span class="dv">500</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[98]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#| eval: false</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> content = <span class="ansi-yellow-bg">get_content_tool</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">hdgs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">      3</span> <span style="color:rgb(0,135,0)">print</span>(content[:<span class="ansi-green-fg">500</span>])

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[97]</span><span class="ansi-green-fg">, line 7</span>, in <span class="ansi-cyan-fg">get_content_tool</span><span class="ansi-blue-fg">(hdgs, keys_list)</span>
<span class="ansi-green-fg">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg">get_content_tool</span>(
<span class="ansi-green-fg">      3</span>     hdgs: <span style="color:rgb(0,135,0)">dict</span>, <span style="font-style:italic;color:rgb(95,135,135)"># The nested dictionary structure</span>
<span class="ansi-green-fg">      4</span>     keys_list: <span style="color:rgb(0,135,0)">list</span>, <span style="font-style:italic;color:rgb(95,135,135)"># The list of keys to navigate through</span>
<span class="ansi-green-fg">      5</span>     ) -&gt; <span style="color:rgb(0,135,0)">str</span>: <span style="font-style:italic;color:rgb(95,135,135)"># The content of the section</span>
<span class="ansi-green-fg">      6</span>     <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Navigate through nested levels using the exact key strings.</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">7</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">reduce</span><span class="ansi-yellow-bg">(</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">lambda</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">current</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">current</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">keys_list</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hdgs</span><span class="ansi-yellow-bg">)</span>.text

<span class="ansi-red-fg">TypeError</span>: reduce() arg 2 must support iteration</pre>
</div>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L152" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="flatten_sections" class="level3">
<h3 class="anchored" data-anchor-id="flatten_sections">flatten_sections</h3>
<blockquote class="blockquote">
<pre><code> flatten_sections (hdgs:dict, path:list=[])</code></pre>
</blockquote>
<p><em>Extract flat list of (key, full_path) tuples from nested hdgs</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>hdgs</td>
<td>dict</td>
<td></td>
<td>The nested dictionary-like structure of the report also allowing to pull content from</td>
</tr>
<tr class="even">
<td>path</td>
<td>list</td>
<td>[]</td>
<td>The current path in the nested structure</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>list</strong></td>
<td></td>
<td><strong>The flat list of (key, full_path) tuples</strong></td>
</tr>
</tbody>
</table>
<div id="cell-32" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flatten_sections(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    hdgs: <span class="bu">dict</span>, <span class="co"># The nested dictionary-like structure of the report also allowing to pull content from </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    path: <span class="bu">list</span> <span class="op">=</span> [] <span class="co"># The current path in the nested structure</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">list</span>: <span class="co"># The flat list of (key, full_path) tuples</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Extract flat list of (key, full_path) tuples from nested hdgs"</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    sections <span class="op">=</span> []</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> hdgs.items():</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        current_path <span class="op">=</span> path <span class="op">+</span> [key]</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        sections.append((key, current_path))</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">dict</span>):</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>            sections.extend(flatten_sections(value, current_path))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sections</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-33" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(flatten_sections(hdgs)[:<span class="dv">10</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
    <span style="font-weight: bold">(</span>
        <span style="color: #008000; text-decoration-color: #008000">'Evaluation of IOM Accountability to Affected Populations'</span>,
        <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'Evaluation of IOM Accountability to Affected Populations'</span><span style="font-weight: bold">]</span>
    <span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span>
        <span style="color: #008000; text-decoration-color: #008000">'IOM CENTRAL EVALUATION'</span>,
        <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'Evaluation of IOM Accountability to Affected Populations'</span>, <span style="color: #008000; text-decoration-color: #008000">'IOM CENTRAL EVALUATION'</span><span style="font-weight: bold">]</span>
    <span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span>
        <span style="color: #008000; text-decoration-color: #008000">'December 2024'</span>,
        <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'Evaluation of IOM Accountability to Affected Populations'</span>, <span style="color: #008000; text-decoration-color: #008000">'IOM CENTRAL EVALUATION'</span>, <span style="color: #008000; text-decoration-color: #008000">'December 2024'</span><span style="font-weight: bold">]</span>
    <span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'ACKNOWLEDGEMENTS'</span>, <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'ACKNOWLEDGEMENTS'</span><span style="font-weight: bold">])</span>,
    <span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'TABLE OF CONTENTS'</span>, <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'TABLE OF CONTENTS'</span><span style="font-weight: bold">])</span>,
    <span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'LIST OF FIGURES AND TABLES'</span>, <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'LIST OF FIGURES AND TABLES'</span><span style="font-weight: bold">])</span>,
    <span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'LIST OF ACRONYMS'</span>, <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'LIST OF ACRONYMS'</span><span style="font-weight: bold">])</span>,
    <span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'EXECUTIVE SUMMARY'</span>, <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'EXECUTIVE SUMMARY'</span><span style="font-weight: bold">])</span>,
    <span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'1. BACKGROUND'</span>, <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'1. BACKGROUND'</span><span style="font-weight: bold">])</span>,
    <span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'Evaluation Context'</span>, <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'1. BACKGROUND'</span>, <span style="color: #008000; text-decoration-color: #008000">'Evaluation Context'</span><span style="font-weight: bold">])</span>
<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L166" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="format_toc_for_llm" class="level3">
<h3 class="anchored" data-anchor-id="format_toc_for_llm">format_toc_for_llm</h3>
<blockquote class="blockquote">
<pre><code> format_toc_for_llm (hdgs:dict)</code></pre>
</blockquote>
<p><em>Format ToC as readable text with page numbers</em></p>
<div id="cell-35" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_toc_for_llm(hdgs: <span class="bu">dict</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Format ToC as readable text with page numbers"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    sections <span class="op">=</span> flatten_sections(hdgs)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> [<span class="ss">f"- </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> key, path <span class="kw">in</span> sections]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(lines)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-36" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(format_toc_for_llm(hdgs)[:<span class="dv">500</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">- Evaluation of IOM Accountability to Affected Populations
- IOM CENTRAL EVALUATION
- December <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>
- ACKNOWLEDGEMENTS
- TABLE OF CONTENTS
- LIST OF FIGURES AND TABLES
- LIST OF ACRONYMS
- EXECUTIVE SUMMARY
- <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>. BACKGROUND
- Evaluation Context
- Evaluation Purpose, Objectives and Scope
- Methodology
- Data Sources
- Desk Review
- Remote and In-Person Key Informant Interviews
- Focus Group Discussions
- Online Survey
- Case Studies
- Sampling
- Limitations
- Ethical Considerations
- <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>. EVALUATION
</pre>
</div>
</div>
</section>
</section>
<section id="formatters" class="level2">
<h2 class="anchored" data-anchor-id="formatters">Formatters</h2>
<p>We define here a set of function formatting both evaluation frameworks themes to analyze (SRF enablers, objectives, GCM objectives, …) and traces.</p>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L173" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="format_enabler_theme" class="level3">
<h3 class="anchored" data-anchor-id="format_enabler_theme">format_enabler_theme</h3>
<blockquote class="blockquote">
<pre><code> format_enabler_theme (theme:evaluatr.frameworks.EvalData)</code></pre>
</blockquote>
<p><em>Format SRF enabler into structured text for LM processing.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>theme</td>
<td>EvalData</td>
<td>The theme object</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td><strong>The formatted theme string</strong></td>
</tr>
</tbody>
</table>
<div id="cell-40" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_enabler_theme(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    theme: EvalData <span class="co"># The theme object</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">str</span>: <span class="co"># The formatted theme string</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Format SRF enabler into structured text for LM processing."</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> [</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'## Enabler </span><span class="sc">{</span>theme<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>theme<span class="sc">.</span>title<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'### Description'</span>, </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        theme.description</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(parts)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For instance:</p>
<div id="cell-42" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>eval_data <span class="op">=</span> IOMEvalData()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>data_evidence <span class="op">=</span> eval_data.srf_enablers[<span class="dv">3</span>]  <span class="co"># "Data and evidence" is at index 3</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(format_enabler_theme(data_evidence))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">## Enabler <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>: Data and evidence
### Description
IOM will be the pre-eminent source of migration and displacement data for action, which help save lives and deliver
solutions; data for insight, which help facilitate regular migration pathways; and data for foresight, which help 
drive anticipatory action. IOM will have the systems and data fluency to collect, safely store, analyze, share and 
apply disaggregated data and evidence across the mobility spectrum. Our extensive data and research repositories 
will underpin evidence-based policies and practices. Data will be central to the internal decision-making and 
management of the Organization.
</pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L185" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="format_crosscutting_theme" class="level3">
<h3 class="anchored" data-anchor-id="format_crosscutting_theme">format_crosscutting_theme</h3>
<blockquote class="blockquote">
<pre><code> format_crosscutting_theme (theme:evaluatr.frameworks.EvalData)</code></pre>
</blockquote>
<p><em>Format SRF cross-cutting into structured text for LM processing.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>theme</td>
<td>EvalData</td>
<td>The theme object</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td><strong>The formatted theme string</strong></td>
</tr>
</tbody>
</table>
<div id="cell-44" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_crosscutting_theme(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    theme: EvalData <span class="co"># The theme object</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">str</span>: <span class="co"># The formatted theme string</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Format SRF cross-cutting into structured text for LM processing."</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> [</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'## Cross-cutting </span><span class="sc">{</span>theme<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>theme<span class="sc">.</span>title<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'### Description'</span>, </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        theme.description</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(parts)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For instance:</p>
<div id="cell-46" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>eval_data <span class="op">=</span> IOMEvalData()</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>env_sustainability <span class="op">=</span> eval_data.srf_crosscutting_priorities[<span class="dv">3</span>]  <span class="co"># "Data and evidence" is at index 3</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(format_crosscutting_theme(env_sustainability))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">## Cross-cutting <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>: Environmental Sustainability
### Description
IOM will lead environmental sustainability innovation for impact and scale in the humanitarian and migration 
management sector. Caring for people and the planet is one of our core values, and we are committed to 
mainstreaming environmental sustainability into our projects and programmes, and facilities management and 
operations. IOM will have an ambitious environmental governance and environmental management system drawing from 
United Nations system-wide commitments
</pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L197" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="format_gcm_theme" class="level3">
<h3 class="anchored" data-anchor-id="format_gcm_theme">format_gcm_theme</h3>
<blockquote class="blockquote">
<pre><code> format_gcm_theme (theme:dict)</code></pre>
</blockquote>
<p><em>Format GCM objective into structured text for LM processing.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>theme</td>
<td>dict</td>
<td>The GCM theme object from gcm_small</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td><strong>The formatted theme string</strong></td>
</tr>
</tbody>
</table>
<div id="cell-48" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_gcm_theme(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    theme: <span class="bu">dict</span> <span class="co"># The GCM theme object from gcm_small</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">str</span>: <span class="co"># The formatted theme string</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Format GCM objective into structured text for LM processing."</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> [</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'## GCM Objective </span><span class="sc">{</span>theme[<span class="st">"id"</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>theme[<span class="st">"title"</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'### Core Theme'</span>, </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>        theme[<span class="st">"core_theme"</span>]</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> theme.get(<span class="st">"key_principles"</span>):</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        parts.extend([<span class="st">'### Key Principles'</span>, <span class="st">', '</span>.join(theme[<span class="st">"key_principles"</span>])])</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> theme.get(<span class="st">"target_groups"</span>):</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>        parts.extend([<span class="st">'### Target Groups'</span>, <span class="st">', '</span>.join(theme[<span class="st">"target_groups"</span>])])</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> theme.get(<span class="st">"main_activities"</span>):</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        parts.extend([<span class="st">'### Main Activities'</span>, <span class="st">', '</span>.join(theme[<span class="st">"main_activities"</span>])])</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(parts)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For instance:</p>
<div id="cell-50" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>gcm_small <span class="op">=</span> eval_data.gcm_objectives_small</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(format_gcm_theme(gcm_small[<span class="dv">3</span>]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">## GCM Objective <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>: Ensure that all migrants have proof of legal identity and adequate documentation
### Core Theme
Strengthen civil registry systems and ensure migrants have necessary identity documents
### Key Principles
Legal identity, Civil registration, Document security, Consular services
### Target Groups
Migrants, Stateless persons, Children, Consular authorities
### Main Activities
Civil registry improvement, Document issuance, Biometric systems, Consular documentation
</pre>
</div>
</div>
<div id="cell-51" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>formatted_objectives <span class="op">=</span> [format_gcm_theme(o) <span class="cf">for</span> o <span class="kw">in</span> gcm_small]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>markdown_content <span class="op">=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(formatted_objectives)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"formatted_gcm_objectives.md"</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    f.write(markdown_content)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dumped </span><span class="sc">{</span><span class="bu">len</span>(formatted_objectives)<span class="sc">}</span><span class="ss"> GCM objectives to </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Dumped <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span> GCM objectives to formatted_gcm_objectives.md
</pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L219" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="format_srf_output" class="level3">
<h3 class="anchored" data-anchor-id="format_srf_output">format_srf_output</h3>
<blockquote class="blockquote">
<pre><code> format_srf_output (output_context:dict)</code></pre>
</blockquote>
<p><em>Format SRF output with full hierarchical context for LM processing.</em></p>
<div id="cell-53" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_srf_output(output_context: <span class="bu">dict</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Format SRF output with full hierarchical context for LM processing."</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> [</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'## SRF Output </span><span class="sc">{</span>output_context[<span class="st">"output"</span>][<span class="st">"id"</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>output_context[<span class="st">"output"</span>][<span class="st">"title"</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'### Strategic Context'</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'**Objective </span><span class="sc">{</span>output_context[<span class="st">"objective"</span>][<span class="st">"id"</span>]<span class="sc">}</span><span class="ss">**: </span><span class="sc">{</span>output_context[<span class="st">"objective"</span>][<span class="st">"title"</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'**Long    -term Outcome </span><span class="sc">{</span>output_context[<span class="st">"long_outcome"</span>][<span class="st">"id"</span>]<span class="sc">}</span><span class="ss">**: </span><span class="sc">{</span>output_context[<span class="st">"long_outcome"</span>][<span class="st">"title"</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'**Short-term Outcome </span><span class="sc">{</span>output_context[<span class="st">"short_outcome"</span>][<span class="st">"id"</span>]<span class="sc">}</span><span class="ss">**: </span><span class="sc">{</span>output_context[<span class="st">"short_outcome"</span>][<span class="st">"title"</span>]<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(parts)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For instance:</p>
<div id="cell-55" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>test_output_id <span class="op">=</span> <span class="st">'1a11'</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>output_context <span class="op">=</span> find_srf_output_by_id(eval_data, test_output_id)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> output_context:</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    formatted <span class="op">=</span> format_srf_output(output_context)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(formatted)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">## SRF Output 1a11: Crisis-affected populations in-need receive dignified shelter and settlement support.
### Strategic Context
**Objective <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>**: Saving lives and protecting people on the move
**Long    -term Outcome 1a**: Human suffering is alleviated while the dignity and rights of people affected by 
crises are upheld.
**Short-term Outcome 1a1**: Crisis-affected populations have their basic needs met and have minimum living 
conditions with reduced barriers to access for marginalized and vulnerable individuals.
</pre>
</div>
</div>
</section>
</section>
<section id="pydantic-models" class="level2">
<h2 class="anchored" data-anchor-id="pydantic-models">Pydantic models</h2>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L232" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="coresectionsoutput" class="level3">
<h3 class="anchored" data-anchor-id="coresectionsoutput">CoreSectionsOutput</h3>
<blockquote class="blockquote">
<pre><code> CoreSectionsOutput (section_names:list[str], reasoning:str)</code></pre>
</blockquote>
<p><em>Identify the core sections of the report</em></p>
<div id="cell-58" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CoreSectionsOutput(BaseModel):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Identify the core sections of the report"</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    section_names: <span class="bu">list</span>[<span class="bu">str</span>]</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    reasoning: <span class="bu">str</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L238" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="evidencelocation" class="level3">
<h3 class="anchored" data-anchor-id="evidencelocation">EvidenceLocation</h3>
<blockquote class="blockquote">
<pre><code> EvidenceLocation (section:str, citation:str)</code></pre>
</blockquote>
<p><em>Identify the location of the evidence in the report</em></p>
<div id="cell-60" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EvidenceLocation(BaseModel):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Identify the location of the evidence in the report"</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    section: <span class="bu">str</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    citation: <span class="bu">str</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L244" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="themetaggingoutput" class="level3">
<h3 class="anchored" data-anchor-id="themetaggingoutput">ThemeTaggingOutput</h3>
<blockquote class="blockquote">
<pre><code> ThemeTaggingOutput (is_core:bool, reasoning:str,
                     evidence_locations:list[__main__.EvidenceLocation],
                     confidence:str)</code></pre>
</blockquote>
<p><em>Tag the theme in the report</em></p>
<div id="cell-62" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemeTaggingOutput(BaseModel):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Tag the theme in the report"</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    is_core: <span class="bu">bool</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    reasoning: <span class="bu">str</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    evidence_locations: <span class="bu">list</span>[EvidenceLocation]</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    confidence: <span class="bu">str</span>  <span class="co"># low/medium/high</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="system-prompts" class="level2">
<h2 class="anchored" data-anchor-id="system-prompts">System prompts</h2>
<div id="cell-64" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>select_section_sp <span class="op">=</span> <span class="st">"""### ROLE AND OBJECTIVE</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="st">You are an expert evaluation report analyst. Your task is to identify sections that would help determine if specific themes are CORE to this report for synthesis and retrieval purposes.</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="st">### CONTEXT</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="st">You will receive a table of contents (ToC) with section headings from an evaluation report. Select sections where report authors signal what matters most - these will be used to tag themes for future synthesis work.</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="st">### SECTIONS TO IDENTIFY</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="st">Look for sections that reveal core themes (in any language):</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="st">1. Executive Summary / Overview / Résumé exécutif / Resumen ejecutivo</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="st">2. Introduction / Objectives / Purpose / Questions d'évaluation / Preguntas de evaluación</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="st">3. Main Findings / Results / Résultats / Resultados / Constatations</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="st">4. Conclusions / Conclusiones</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="st">5. Recommendations / Recommandations / Recomendaciones</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="st">### SELECTION CRITERIA</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="st">- Match flexibly by meaning, not exact wording</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="st">- Prioritize where authors explicitly state what's important</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="st">- Aim for ~8-10 pages total (use page numbers in ToC as guide)</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="st">- Avoid methodology, background, annexes unless unusually central</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="st">- Not all report types have all sections - select what exists</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="st">### OUTPUT FORMAT</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="st">JSON with section_names (list) and reasoning (string).</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="st">**CRITICAL**: section_names must contain EXACT strings from the ToC provided.</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a><span class="st">Copy the complete line including section numbers and page references.</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="st">Example: If ToC shows "4.1. Relevance of programme activities .... page 34"</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="st">Return exactly: "4.1. Relevance of programme activities .... page 34"</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-65" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>tagging_sp <span class="op">=</span> <span class="st">"""### ROLE AND OBJECTIVE</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="st">You are an evaluation synthesis specialist. Your task is to determine if this report should be tagged with a specific theme for future retrieval in synthesis work.</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="st">### CONTEXT</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="st">You will receive:</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="st">- Key sections from an evaluation report</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="st">- A specific theme to evaluate</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="st">### CRITICAL DISTINCTION</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="st">You are NOT evaluating whether the theme is mentioned or relevant.</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="st">You ARE evaluating whether the theme is CENTRAL to what this report is fundamentally about.</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="st">### TAGGING DECISION CRITERIA</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="st">Tag as CORE only if the theme meets BOTH conditions:</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="st">**1. Centrality Test**: The theme is a PRIMARY focus of the report:</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="st">- The theme appears in the report's main objectives/evaluation questions</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="st">- Multiple major sections dedicate substantial analysis to this theme</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="st">- Key findings and conclusions center on this theme</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="st">- Major recommendations address this theme</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="st">**2. Synthesis Value Test**: Ask yourself:</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="st">"If I were synthesizing evaluation findings specifically on [Theme X], would EXCLUDING this report create a significant gap in my synthesis?"</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="st">### DECISION RULE</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="st">- Tag as CORE: The report would be among the TOP sources for a synthesis on this theme</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="st">- Tag as NOT CORE: The report mentions the theme but isn't fundamentally about it</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="st">**When uncertain → Tag as NOT CORE**</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="st">Aim for precision: Only 2-4 themes per report should be CORE.</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="st">### OUTPUT FORMAT</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="st">JSON with:</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="st">- is_core: boolean</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a><span class="st">- reasoning: explain centrality (or lack thereof) with specific evidence</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="st">- evidence_locations: list of {"section": "...", "citation": "..."}</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="st">- confidence: low/medium/high</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-66" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>tagging_sp_no_citation <span class="op">=</span> <span class="st">"""### ROLE AND OBJECTIVE</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="st">You are an evaluation synthesis specialist. Your task is to determine if this report should be tagged with a </span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="st">specific theme for future retrieval in synthesis work.</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="st">### CONTEXT</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="st">You will receive:</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="st">- Key sections from an evaluation report</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="st">- A specific theme to evaluate</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="st">### CRITICAL DISTINCTION</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="st">You are NOT evaluating whether the theme is mentioned or relevant.</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="st">You ARE evaluating whether the theme is CENTRAL to what this report is fundamentally about.</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="st">### TAGGING DECISION CRITERIA</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="st">Tag as CORE only if the theme meets BOTH conditions:</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="st">**1. Centrality Test**: The theme is a PRIMARY focus of the report:</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="st">- The theme appears in the report's main objectives/evaluation questions</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="st">- Multiple major sections dedicate substantial analysis to this theme</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="st">- Key findings and conclusions center on this theme</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="st">- Major recommendations address this theme</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="st">**2. Synthesis Value Test**: Ask yourself:</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="st">"If I were synthesizing evaluation findings specifically on [Theme X], would EXCLUDING this report create a </span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="st">significant gap in my synthesis?"</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="st">### DECISION RULE</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a><span class="st">- Tag as CORE: The report would be among the TOP sources for a synthesis on this theme</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="st">- Tag as NOT CORE: The report mentions the theme but isn't fundamentally about it</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="st">**When uncertain → Tag as NOT CORE**</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a><span class="st">Aim for precision: Only 2-4 themes per report should be CORE.</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a><span class="st">### OUTPUT FORMAT</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a><span class="st">JSON with:</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a><span class="st">- is_core: boolean</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="st">- reasoning: explain centrality (or lack thereof) with specific evidence (max 150 words)</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="st">- confidence: low/medium/high"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="theme-analysis-core-steps" class="level2">
<h2 class="anchored" data-anchor-id="theme-analysis-core-steps">Theme analysis core steps</h2>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L365" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="parse_response" class="level3">
<h3 class="anchored" data-anchor-id="parse_response">parse_response</h3>
<blockquote class="blockquote">
<pre><code> parse_response (result)</code></pre>
</blockquote>
<p><em>Extract JSON from Lisette response</em></p>
<div id="cell-69" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_response(result):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Extract JSON from Lisette response"</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.loads(result.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="select-sections-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="select-sections-of-interest">Select sections of interest</h3>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L370" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="identify_core_sections" class="level3">
<h3 class="anchored" data-anchor-id="identify_core_sections">identify_core_sections</h3>
<blockquote class="blockquote">
<pre><code> identify_core_sections (hdgs:dict, system_prompt:str,
                         model:str='gemini/gemini-2.0-flash')</code></pre>
</blockquote>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>hdgs</td>
<td>dict</td>
<td></td>
<td>The nested dictionary-like structure of the report also allowing to pull content from</td>
</tr>
<tr class="even">
<td>system_prompt</td>
<td>str</td>
<td></td>
<td>The system prompt for the core sections identification</td>
</tr>
<tr class="odd">
<td>model</td>
<td>str</td>
<td>gemini/gemini-2.0-flash</td>
<td>The model to use</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>dict</strong></td>
<td></td>
<td><strong>The JSON response from the model</strong></td>
</tr>
</tbody>
</table>
<div id="cell-72" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> identify_core_sections(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    hdgs: <span class="bu">dict</span>, <span class="co"># The nested dictionary-like structure of the report also allowing to pull content from </span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    system_prompt: <span class="bu">str</span>, <span class="co"># The system prompt for the core sections identification</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    model: <span class="bu">str</span> <span class="op">=</span> <span class="st">'gemini/gemini-2.0-flash'</span> <span class="co"># The model to use</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>: <span class="co"># The JSON response from the model</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> AsyncChat(model<span class="op">=</span>model, sp<span class="op">=</span>system_prompt, temp<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    toc_text <span class="op">=</span> format_toc_for_llm(hdgs)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="cf">await</span> chat(</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Here is the table of contents:</span><span class="ch">\n\n</span><span class="sc">{</span>toc_text<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>        response_format<span class="op">=</span>CoreSectionsOutput</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parse_response(result)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-73" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>core_sections <span class="op">=</span> <span class="cf">await</span> identify_core_sections(hdgs, select_section_sp)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(core_sections)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'section_names'</span>: <span style="font-weight: bold">[</span>
        <span style="color: #008000; text-decoration-color: #008000">'EXECUTIVE SUMMARY .... page 5'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'Findings .... page 6'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'Conclusions .... page 6'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'Recommendations .... page 8'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'1. OBJECTIVE, SCOPE AND METHODOLOGY OF THE EVALUATION .... page 9'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'Objective of the Evaluation .... page 9'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'3. MAIN EVALUATION FINDINGS .... page 18'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'4. CONCLUSIONS .... page 48'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'5. RECOMMENDATIONS .... page 53'</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'reasoning'</span>: <span style="color: #008000; text-decoration-color: #008000">'The selected sections cover the core elements of the evaluation report, including the executive </span>
<span style="color: #008000; text-decoration-color: #008000">summary, findings, conclusions, and recommendations. The objective and scope section provides context for the </span>
<span style="color: #008000; text-decoration-color: #008000">evaluation. These sections are most likely to contain the key themes and insights from the evaluation.'</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L384" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="extract_core_content" class="level3">
<h3 class="anchored" data-anchor-id="extract_core_content">extract_core_content</h3>
<blockquote class="blockquote">
<pre><code> extract_core_content (core_section_names:list[str], hdgs:dict)</code></pre>
</blockquote>
<p><em>Extract and combine content from core sections</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>core_section_names</td>
<td>list</td>
<td>Section names from Step 1</td>
</tr>
<tr class="even">
<td>hdgs</td>
<td>dict</td>
<td>Nested heading structure</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td><strong>Combined content with section headers</strong></td>
</tr>
</tbody>
</table>
<div id="cell-75" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_core_content(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    core_section_names: <span class="bu">list</span>[<span class="bu">str</span>],  <span class="co"># Section names from Step 1</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    hdgs: <span class="bu">dict</span>  <span class="co"># Nested heading structure</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:  <span class="co"># Combined content with section headers</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Extract and combine content from core sections"</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> core_section_names:</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        logging.warning(<span class="st">"No core sections provided"</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    sections_lookup <span class="op">=</span> {key: path <span class="cf">for</span> key, path <span class="kw">in</span> flatten_sections(hdgs)}</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    content_parts <span class="op">=</span> []</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> section_name <span class="kw">in</span> core_section_names:</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> section_name <span class="kw">not</span> <span class="kw">in</span> sections_lookup:</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>            logging.warning(<span class="ss">f"Section not found: </span><span class="sc">{</span>section_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> sections_lookup[section_name]</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> get_content_tool(hdgs, path)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>        content_parts.append(content)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">---</span><span class="ch">\n\n</span><span class="st">"</span>.join(content_parts)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-76" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(extract_core_content(core_sections[<span class="st">'section_names'</span>], hdgs)[:<span class="dv">500</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"># EXECUTIVE SUMMARY <span style="color: #808000; text-decoration-color: #808000">...</span>. page <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>

The International Organization for Migration <span style="font-weight: bold">(</span>IOM<span style="font-weight: bold">)</span><span style="color: #008000; text-decoration-color: #008000">'s Central Evaluation Division (CED) commissioned this thematic </span>
<span style="color: #008000; text-decoration-color: #008000">and strategic evaluation of IOM'</span>s Mental Health and Psychosocial Support <span style="font-weight: bold">(</span>MHPSS<span style="font-weight: bold">)</span> work as part of the biennial 
evaluation plan <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>. MHPSS has become an area of institutional importance to IOM, and the evaluation provided
the opportunity to take stock of IOM's work in MHPSS since the post-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2015</span> development agenda, including internal 
synergies, adap
</pre>
</div>
</div>
<div id="cell-77" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>core_content <span class="op">=</span> extract_core_content(core_sections[<span class="st">'section_names'</span>], hdgs)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> Path(<span class="st">"retrieved_core_sections.md"</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>output_path.write_text(core_content, encoding<span class="op">=</span><span class="st">"utf-8"</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dumped </span><span class="sc">{</span><span class="bu">len</span>(core_sections[<span class="st">'section_names'</span>])<span class="sc">}</span><span class="ss"> core sections to </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Dumped <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span> core sections to retrieved_core_sections.md
</pre>
</div>
</div>
</section>
<section id="tagging" class="level3">
<h3 class="anchored" data-anchor-id="tagging">Tagging</h3>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L407" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="tagresult" class="level3">
<h3 class="anchored" data-anchor-id="tagresult">TagResult</h3>
<blockquote class="blockquote">
<pre><code> TagResult (is_core:bool, reasoning:str, confidence:str)</code></pre>
</blockquote>
<p><em>The result of the theme tagging</em></p>
<div id="cell-80" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TagResult(BaseModel):</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"The result of the theme tagging"</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    is_core: <span class="bu">bool</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    reasoning: <span class="bu">str</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    confidence: <span class="bu">str</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L414" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="tag_theme" class="level3">
<h3 class="anchored" data-anchor-id="tag_theme">tag_theme</h3>
<blockquote class="blockquote">
<pre><code> tag_theme (doc_content:str, theme:str, system_prompt:str,
            response_format:type=&lt;class '__main__.TagResult'&gt;,
            model:str='claude-sonnet-4-5', cache_system:bool=True,
            cache_theme:bool=False)</code></pre>
</blockquote>
<p><em>Tag a single theme against the document</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>doc_content</td>
<td>str</td>
<td></td>
<td>The content of the document to analyze</td>
</tr>
<tr class="even">
<td>theme</td>
<td>str</td>
<td></td>
<td>The theme to tag</td>
</tr>
<tr class="odd">
<td>system_prompt</td>
<td>str</td>
<td></td>
<td>The system prompt for the theme tagging</td>
</tr>
<tr class="even">
<td>response_format</td>
<td>type</td>
<td>TagResult</td>
<td>The response format for the theme tagging</td>
</tr>
<tr class="odd">
<td>model</td>
<td>str</td>
<td>claude-sonnet-4-5</td>
<td>The model to use</td>
</tr>
<tr class="even">
<td>cache_system</td>
<td>bool</td>
<td>True</td>
<td>Always cache system+doc (default)</td>
</tr>
<tr class="odd">
<td>cache_theme</td>
<td>bool</td>
<td>False</td>
<td>Only cache theme for resume</td>
</tr>
</tbody>
</table>
<div id="cell-82" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> tag_theme(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    doc_content: <span class="bu">str</span>, <span class="co"># The content of the document to analyze</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    theme: <span class="bu">str</span>, <span class="co"># The theme to tag</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    system_prompt: <span class="bu">str</span>, <span class="co"># The system prompt for the theme tagging</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    response_format: <span class="bu">type</span> <span class="op">=</span> TagResult, <span class="co"># The response format for the theme tagging</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"claude-sonnet-4-5"</span>, <span class="co"># The model to use</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    cache_system: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>,   <span class="co"># Always cache system+doc (default)</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    cache_theme: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>     <span class="co"># Only cache theme for resume</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Tag a single theme against the document"</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    system_blocks <span class="op">=</span> [</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"type"</span>: <span class="st">"text"</span>, <span class="st">"text"</span>: system_prompt},</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"type"</span>: <span class="st">"text"</span>, <span class="st">"text"</span>: <span class="ss">f"</span><span class="ch">\n\n</span><span class="ss">## Document to Analyze</span><span class="ch">\n\n</span><span class="sc">{</span>doc_content<span class="sc">}</span><span class="ss">"</span>}</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cache_system: system_blocks[<span class="op">-</span><span class="dv">1</span>][<span class="st">"cache_control"</span>] <span class="op">=</span> {<span class="st">"type"</span>: <span class="st">"ephemeral"</span>}</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [mk_msg(theme, cache<span class="op">=</span>cache_theme)]</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> <span class="cf">await</span> acompletion(</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>messages,</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>        system<span class="op">=</span>system_blocks,</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>        response_format<span class="op">=</span>response_format</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-83" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>theme <span class="op">=</span> format_enabler_theme(eval_data.srf_enablers[<span class="dv">0</span>])</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>core_content <span class="op">=</span> extract_core_content(core_sections[<span class="st">'section_names'</span>], hdgs)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> <span class="cf">await</span> tag_theme(</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    doc_content<span class="op">=</span>core_content, </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    theme<span class="op">=</span>theme, </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    system_prompt<span class="op">=</span>tagging_sp_no_citation, </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    response_format<span class="op">=</span>TagResult,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    cache_system<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    cache_theme<span class="op">=</span><span class="va">True</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">ModelResponse</span><span style="font-weight: bold">(</span>
    <span style="color: #808000; text-decoration-color: #808000">id</span>=<span style="color: #008000; text-decoration-color: #008000">'chatcmpl-09cff953-caaa-4677-bff5-4039d8a978d6'</span>,
    <span style="color: #808000; text-decoration-color: #808000">created</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1762791010</span>,
    <span style="color: #808000; text-decoration-color: #808000">model</span>=<span style="color: #008000; text-decoration-color: #008000">'claude-sonnet-4-5-20250929'</span>,
    <span style="color: #808000; text-decoration-color: #808000">object</span>=<span style="color: #008000; text-decoration-color: #008000">'chat.completion'</span>,
    <span style="color: #808000; text-decoration-color: #808000">system_fingerprint</span>=<span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>,
    <span style="color: #808000; text-decoration-color: #808000">choices</span>=<span style="font-weight: bold">[</span>
        <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Choices</span><span style="font-weight: bold">(</span>
            <span style="color: #808000; text-decoration-color: #808000">finish_reason</span>=<span style="color: #008000; text-decoration-color: #008000">'stop'</span>,
            <span style="color: #808000; text-decoration-color: #808000">index</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
            <span style="color: #808000; text-decoration-color: #808000">message</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Message</span><span style="font-weight: bold">(</span>
                <span style="color: #808000; text-decoration-color: #808000">content</span>=<span style="color: #008000; text-decoration-color: #008000">'{"is_core": false, "reasoning": "While the report extensively discusses IOM staff </span>
<span style="color: #008000; text-decoration-color: #008000">capacity, training, and human resources (particularly in the Efficiency section noting that \\"human resources were</span>
<span style="color: #008000; text-decoration-color: #008000">mostly sufficient\\" and improvements in \\"allocating additional qualified staff\\"), workforce development is not</span>
<span style="color: #008000; text-decoration-color: #008000">a primary focus of this evaluation. The report is fundamentally about assessing the EU-IOM Joint Initiative\'s </span>
<span style="color: #008000; text-decoration-color: #008000">migrant protection, return, and reintegration program outcomes. \\n\\nStaff and workforce considerations appear as </span>
<span style="color: #008000; text-decoration-color: #008000">operational inputs and implementation factors rather than as central evaluation questions. The main themes are: </span>
<span style="color: #008000; text-decoration-color: #008000">migrant protection and safe return, reintegration support (economic, social, psychosocial), community-based </span>
<span style="color: #008000; text-decoration-color: #008000">projects, government capacity building, and program sustainability. \\n\\nWorkforce issues are mentioned </span>
<span style="color: #008000; text-decoration-color: #008000">instrumentally - how adequate staffing contributed to program delivery - but there are no dedicated sections </span>
<span style="color: #008000; text-decoration-color: #008000">analyzing workforce planning, staff well-being, leadership development, or organizational culture. The </span>
<span style="color: #008000; text-decoration-color: #008000">capacity-building discussed focuses on external stakeholders (governments, service providers) rather than internal </span>
<span style="color: #008000; text-decoration-color: #008000">IOM workforce development. \\n\\nFor a synthesis specifically on IOM workforce development, this report would </span>
<span style="color: #008000; text-decoration-color: #008000">provide minimal substantive content.", "confidence": "high"}'</span>,
                <span style="color: #808000; text-decoration-color: #808000">role</span>=<span style="color: #008000; text-decoration-color: #008000">'assistant'</span>,
                <span style="color: #808000; text-decoration-color: #808000">tool_calls</span>=<span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>,
                <span style="color: #808000; text-decoration-color: #808000">function_call</span>=<span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>,
                <span style="color: #808000; text-decoration-color: #808000">provider_specific_fields</span>=<span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>
            <span style="font-weight: bold">)</span>
        <span style="font-weight: bold">)</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #808000; text-decoration-color: #808000">usage</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Usage</span><span style="font-weight: bold">(</span>
        <span style="color: #808000; text-decoration-color: #808000">completion_tokens</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">293</span>,
        <span style="color: #808000; text-decoration-color: #808000">prompt_tokens</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>,
        <span style="color: #808000; text-decoration-color: #808000">total_tokens</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">319</span>,
        <span style="color: #808000; text-decoration-color: #808000">completion_tokens_details</span>=<span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>,
        <span style="color: #808000; text-decoration-color: #808000">prompt_tokens_details</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">PromptTokensDetailsWrapper</span><span style="font-weight: bold">(</span>
            <span style="color: #808000; text-decoration-color: #808000">audio_tokens</span>=<span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>,
            <span style="color: #808000; text-decoration-color: #808000">cached_tokens</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
            <span style="color: #808000; text-decoration-color: #808000">text_tokens</span>=<span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>,
            <span style="color: #808000; text-decoration-color: #808000">image_tokens</span>=<span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>
        <span style="font-weight: bold">)</span>,
        <span style="color: #808000; text-decoration-color: #808000">cache_creation_input_tokens</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9568</span>,
        <span style="color: #808000; text-decoration-color: #808000">cache_read_input_tokens</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>
    <span style="font-weight: bold">)</span>
<span style="font-weight: bold">)</span>
</pre>
</div>
</div>
</section>
</section>
<section id="logging" class="level2">
<h2 class="anchored" data-anchor-id="logging">Logging</h2>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L442" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="stage" class="level3">
<h3 class="anchored" data-anchor-id="stage">Stage</h3>
<blockquote class="blockquote">
<pre><code> Stage (value, names=None, module=None, qualname=None, type=None, start=1)</code></pre>
</blockquote>
<p><em>Pipeline stage number</em></p>
<div id="cell-86" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Stage(Enum):</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Pipeline stage number"</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    STAGE1 <span class="op">=</span> <span class="st">"stage1"</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    STAGE2 <span class="op">=</span> <span class="st">"stage2"</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    STAGE3 <span class="op">=</span> <span class="st">"stage3"</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>): <span class="cf">return</span> <span class="va">self</span>.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We treat observability and LLM evaluation as core requirements for our mapping pipeline. While DSPy’s built-in <code>dspy.inspect_history()</code> provides valuable reasoning chains, we enhance it with structured metadata (<code>report_id</code>, <code>phase</code>, <code>framework</code>) to create comprehensive audit trails. This enriched tracing enables systematic evaluation of mapping accuracy, supports human evaluator annotation workflows, and provides the detailed context necessary for debugging and improving our LLM-based document analysis system.</p>
<p>We define below enum and configuration classes for pipeline tracing and validation. These provide structured metadata for audit trails and evaluation.</p>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L450" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="tracecontext" class="level3">
<h3 class="anchored" data-anchor-id="tracecontext">TraceContext</h3>
<blockquote class="blockquote">
<pre><code> TraceContext (report_id:str, stage:__main__.Stage,
               framework:evaluatr.frameworks.FrameworkInfo)</code></pre>
</blockquote>
<p><em>Context for tracing the mapping process</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>report_id</td>
<td>str</td>
<td>Report identifier</td>
</tr>
<tr class="even">
<td>stage</td>
<td>Stage</td>
<td>Pipeline stage number</td>
</tr>
<tr class="odd">
<td>framework</td>
<td>FrameworkInfo</td>
<td>Framework info (name, category, theme_id)</td>
</tr>
</tbody>
</table>
<div id="cell-89" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TraceContext(AttrDict):</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Context for tracing the mapping process"</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                 report_id:<span class="bu">str</span>,  <span class="co"># Report identifier</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                 stage:Stage,  <span class="co"># Pipeline stage number</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>                 framework:FrameworkInfo,  <span class="co"># Framework info (name, category, theme_id)</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                 ): </span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>        store_attr()</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"TraceContext(report_id=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>report_id<span class="sc">}</span><span class="ss">, stage=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>stage<span class="sc">}</span><span class="ss">, framework=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>framework<span class="sc">}</span><span class="ss">)"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-90" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>tr_ctx <span class="op">=</span> TraceContext(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    report_id<span class="op">=</span><span class="st">'49d2fba781b6a7c0d94577479636ee6f'</span>, </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    stage<span class="op">=</span>Stage.STAGE1, </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    framework<span class="op">=</span>FrameworkInfo(Framework.SRF, FrameworkCat.ENABLERS, <span class="st">"4"</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>tr_ctx</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="er">TraceContext(report_id=49d2fba781b6a7c0d94577479636ee6f,</span> <span class="er">stage=stage1,</span> <span class="er">framework=</span><span class="fu">{</span><span class="er">'category'</span><span class="fu">:</span> <span class="er">'Enablers'</span><span class="fu">,</span> <span class="er">'theme_id'</span><span class="fu">:</span> <span class="er">'</span><span class="dv">4</span><span class="er">'</span><span class="fu">,</span> <span class="er">'name'</span><span class="fu">:</span> <span class="er">'SRF'</span><span class="fu">}</span><span class="er">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L463" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="setup_logger" class="level3">
<h3 class="anchored" data-anchor-id="setup_logger">setup_logger</h3>
<blockquote class="blockquote">
<pre><code> setup_logger (name:str, handler:logging.Handler, level:int=20,
               **kwargs:dict)</code></pre>
</blockquote>
<p><em>Helper function to setup a logger with common configuration</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>str</td>
<td></td>
<td>The name of the logger</td>
</tr>
<tr class="even">
<td>handler</td>
<td>Handler</td>
<td></td>
<td>The handler to use</td>
</tr>
<tr class="odd">
<td>level</td>
<td>int</td>
<td>20</td>
<td>The level of the logger</td>
</tr>
<tr class="even">
<td>kwargs</td>
<td>dict</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div id="cell-92" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_logger(</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span>, <span class="co"># The name of the logger</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    handler: logging.Handler, <span class="co"># The handler to use</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    level: <span class="bu">int</span> <span class="op">=</span> logging.INFO, <span class="co"># The level of the logger</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs: <span class="bu">dict</span> <span class="co"># Additional keyword arguments</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper function to setup a logger with common configuration"</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    logger <span class="op">=</span> logging.getLogger(name)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    logger.handlers.clear()</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    logger.addHandler(handler)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    logger.setLevel(level)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k,v <span class="kw">in</span> kwargs.items(): <span class="bu">setattr</span>(logger, k, v)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> logger</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L478" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="setup_trace_logging" class="level3">
<h3 class="anchored" data-anchor-id="setup_trace_logging">setup_trace_logging</h3>
<blockquote class="blockquote">
<pre><code> setup_trace_logging (report_id:str, verbosity:int=1)</code></pre>
</blockquote>
<p><em>Setup logging for trace analysis</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>report_id</td>
<td>str</td>
<td></td>
<td>The report identifier</td>
</tr>
<tr class="even">
<td>verbosity</td>
<td>int</td>
<td>1</td>
<td>The verbosity level</td>
</tr>
</tbody>
</table>
<div id="cell-94" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_trace_logging(</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    report_id: <span class="bu">str</span>, <span class="co"># The report identifier</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    verbosity: <span class="bu">int</span> <span class="op">=</span> cfg.verbosity <span class="co"># The verbosity level</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Setup logging for trace analysis"</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S"</span>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>report_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">.jsonl'</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    file_handler <span class="op">=</span> logging.FileHandler(traces_dir <span class="op">/</span> filename, mode<span class="op">=</span><span class="st">'w'</span>)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    setup_logger(<span class="st">'trace.file'</span>, file_handler)    </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    console_handler <span class="op">=</span> logging.StreamHandler()</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    setup_logger(<span class="st">'trace.console'</span>, console_handler, verbosity<span class="op">=</span>verbosity)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L542" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="log_analysis_event" class="level3">
<h3 class="anchored" data-anchor-id="log_analysis_event">log_analysis_event</h3>
<blockquote class="blockquote">
<pre><code> log_analysis_event (event:str, report_id:str, stage:__main__.Stage=None,
                     framework_info:evaluatr.frameworks.FrameworkInfo=None
                     , **extra_data:dict)</code></pre>
</blockquote>
<p><em>Log an analysis event to file and console with different verbosity levels</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>event</td>
<td>str</td>
<td></td>
<td>The event to log</td>
</tr>
<tr class="even">
<td>report_id</td>
<td>str</td>
<td></td>
<td>The report identifier</td>
</tr>
<tr class="odd">
<td>stage</td>
<td>Stage</td>
<td>None</td>
<td>The stage of the pipeline</td>
</tr>
<tr class="even">
<td>framework_info</td>
<td>FrameworkInfo</td>
<td>None</td>
<td>The framework information</td>
</tr>
<tr class="odd">
<td>extra_data</td>
<td>dict</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div id="cell-96" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _build_base_data(</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    event: <span class="bu">str</span>, <span class="co"># The event to log</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    report_id: <span class="bu">str</span>, <span class="co"># The report identifier</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    stage: Stage <span class="op">=</span> <span class="va">None</span>, <span class="co"># The stage of the pipeline</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    framework_info: FrameworkInfo <span class="op">=</span> <span class="va">None</span>, <span class="co"># The framework information</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>extra_data: <span class="bu">dict</span> <span class="co"># Additional keyword arguments</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Build base data dictionary for logging"</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    base_data <span class="op">=</span> {</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"timestamp"</span>: datetime.now().isoformat(),</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"event"</span>: event,</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"report_id"</span>: report_id,</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stage:</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>        base_data[<span class="st">"stage"</span>] <span class="op">=</span> <span class="bu">str</span>(stage)</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> framework_info:</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>        base_data.update({</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"framework"</span>: <span class="bu">str</span>(framework_info.name),</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"framework_category"</span>: <span class="bu">str</span>(framework_info.category),</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"framework_theme_id"</span>: <span class="bu">str</span>(framework_info.theme_id),</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>    base_data.update(extra_data)</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> base_data</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-97" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _format_console_msg(</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    base_data: <span class="bu">dict</span>, <span class="co"># The base data to format</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    verbosity: <span class="bu">int</span>, <span class="co"># The verbosity level</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    stage: Stage, <span class="co"># The stage of the pipeline</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    framework_info: FrameworkInfo <span class="co"># The framework information</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Format console message based on verbosity level"</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    report_id <span class="op">=</span> base_data[<span class="st">'report_id'</span>]</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    event <span class="op">=</span> base_data[<span class="st">'event'</span>]</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbosity <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>report_id<span class="sc">}</span><span class="ss">"</span> <span class="op">+</span> (<span class="ss">f" - </span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> stage <span class="cf">else</span> <span class="st">""</span>)</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> verbosity <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">=</span> [report_id]</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stage: parts.append(<span class="bu">str</span>(stage))</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>        parts.append(event)</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> framework_info:</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>            parts.append(<span class="ss">f"</span><span class="sc">{</span>framework_info<span class="sc">.</span>name<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>framework_info<span class="sc">.</span>category<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>framework_info<span class="sc">.</span>theme_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">" - "</span>.join(parts)</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># verbosity == 3</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json.dumps(base_data, indent<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-98" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_analysis_event(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    event: <span class="bu">str</span>, <span class="co"># The event to log</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    report_id: <span class="bu">str</span>, <span class="co"># The report identifier</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    stage: Stage <span class="op">=</span> <span class="va">None</span>, <span class="co"># The stage of the pipeline</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    framework_info: FrameworkInfo <span class="op">=</span> <span class="va">None</span>, <span class="co"># The framework information</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>extra_data: <span class="bu">dict</span> <span class="co"># Additional keyword arguments</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Log an analysis event to file and console with different verbosity levels"</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    file_logger <span class="op">=</span> logging.getLogger(<span class="st">'trace.file'</span>)</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    console_logger <span class="op">=</span> logging.getLogger(<span class="st">'trace.console'</span>)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    base_data <span class="op">=</span> _build_base_data(event, report_id, stage, framework_info, <span class="op">**</span>extra_data)</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># File logger - always full JSON</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    file_logger.info(json.dumps(base_data, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Console logger - verbosity-based</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(console_logger, <span class="st">'verbosity'</span>):</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        console_msg <span class="op">=</span> _format_console_msg(base_data, console_logger.verbosity, </span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>                                         stage, framework_info)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>        console_logger.info(console_msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="pipeline-orchestrator" class="level2">
<h2 class="anchored" data-anchor-id="pipeline-orchestrator">Pipeline Orchestrator</h2>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L566" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="get_from_cache" class="level3">
<h3 class="anchored" data-anchor-id="get_from_cache">get_from_cache</h3>
<blockquote class="blockquote">
<pre><code> get_from_cache (table, pk_value:str)</code></pre>
</blockquote>
<p><em>Generic cache retrieval, returns None if not found</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>table</td>
<td></td>
<td>The cache table</td>
</tr>
<tr class="even">
<td>pk_value</td>
<td>str</td>
<td>The primary key value</td>
</tr>
</tbody>
</table>
<div id="cell-101" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_from_cache(</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    table, <span class="co"># The cache table</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    pk_value: <span class="bu">str</span> <span class="co"># The primary key value</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Generic cache retrieval, returns None if not found"</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> table.get(pk_value)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> NotFoundError:</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L577" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="store_in_cache" class="level3">
<h3 class="anchored" data-anchor-id="store_in_cache">store_in_cache</h3>
<blockquote class="blockquote">
<pre><code> store_in_cache (table, data:dict)</code></pre>
</blockquote>
<p><em>Generic cache storage with automatic timestamp</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>table</td>
<td></td>
<td>The cache table</td>
</tr>
<tr class="even">
<td>data</td>
<td>dict</td>
<td>The data to store</td>
</tr>
</tbody>
</table>
<div id="cell-103" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> store_in_cache(</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    table, <span class="co"># The cache table</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    data: <span class="bu">dict</span> <span class="co"># The data to store</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Generic cache storage with automatic timestamp"</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'timestamp'</span>] <span class="op">=</span> datetime.now().isoformat()</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    table.upsert(data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L586" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="limit" class="level3">
<h3 class="anchored" data-anchor-id="limit">limit</h3>
<blockquote class="blockquote">
<pre><code> limit (semaphore, coro, delay:float=None)</code></pre>
</blockquote>
<p><em>Execute coroutine with semaphore concurrency control</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>semaphore</td>
<td></td>
<td></td>
<td>The semaphore to use</td>
</tr>
<tr class="even">
<td>coro</td>
<td></td>
<td></td>
<td>The coroutine to execute</td>
</tr>
<tr class="odd">
<td>delay</td>
<td>float</td>
<td>None</td>
<td>The delay to wait</td>
</tr>
</tbody>
</table>
<div id="cell-105" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> limit(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    semaphore, <span class="co"># The semaphore to use</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    coro, <span class="co"># The coroutine to execute</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    delay: <span class="bu">float</span> <span class="op">=</span> <span class="va">None</span> <span class="co"># The delay to wait</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Execute coroutine with semaphore concurrency control"</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> semaphore:</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> coro</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> delay: <span class="cf">await</span> sleep(delay)</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L598" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="taggingresult" class="level3">
<h3 class="anchored" data-anchor-id="taggingresult">TaggingResult</h3>
<blockquote class="blockquote">
<pre><code> TaggingResult (response:dict,
                framework_info:evaluatr.frameworks.FrameworkInfo)</code></pre>
</blockquote>
<p><em>The result of the theme tagging</em></p>
<div id="cell-107" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TaggingResult(AttrDict):</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"The result of the theme tagging"</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, response: <span class="bu">dict</span>, framework_info: FrameworkInfo):</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.is_core <span class="op">=</span> response[<span class="st">'is_core'</span>]</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reasoning <span class="op">=</span> response[<span class="st">'reasoning'</span>]</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.confidence <span class="op">=</span> response[<span class="st">'confidence'</span>]</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.framework_name <span class="op">=</span> framework_info.name</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.framework_category <span class="op">=</span> framework_info.category</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.framework_theme_id <span class="op">=</span> framework_info.theme_id</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L609" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineresults" class="level3">
<h3 class="anchored" data-anchor-id="pipelineresults">PipelineResults</h3>
<blockquote class="blockquote">
<pre><code> PipelineResults ()</code></pre>
</blockquote>
<p><em>The results of the pipeline</em></p>
<div id="cell-109" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PipelineResults(<span class="bu">dict</span>):</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"The results of the pipeline"</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>[Stage.STAGE1] <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: defaultdict(<span class="bu">dict</span>))</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>[Stage.STAGE2] <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: defaultdict(<span class="bu">dict</span>))</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>[Stage.STAGE3] <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: defaultdict(<span class="bu">dict</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L619" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineresults.__call__" class="level3">
<h3 class="anchored" data-anchor-id="pipelineresults.__call__">PipelineResults.__call__</h3>
<blockquote class="blockquote">
<pre><code> PipelineResults.__call__ (stage:__main__.Stage=&lt;Stage.STAGE1: 'stage1'&gt;,
                           filter_type:str='all')</code></pre>
</blockquote>
<p><em>The results of the pipeline</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>stage</td>
<td>Stage</td>
<td>stage1</td>
<td>The stage of the pipeline</td>
</tr>
<tr class="even">
<td>filter_type</td>
<td>str</td>
<td>all</td>
<td>The filter type</td>
</tr>
</tbody>
</table>
<div id="cell-111" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>:PipelineResults, </span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    stage: Stage <span class="op">=</span> Stage.STAGE1, <span class="co"># The stage of the pipeline</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    filter_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">"all"</span> <span class="co"># The filter type</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"The results of the pipeline"</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    themes <span class="op">=</span> []</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> frameworks <span class="kw">in</span> <span class="va">self</span>[stage].values():</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> categories <span class="kw">in</span> frameworks.values():</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> theme <span class="kw">in</span> categories.values():</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> filter_type <span class="op">==</span> <span class="st">"all"</span> <span class="kw">or</span> <span class="op">\</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>                   (filter_type <span class="op">==</span> <span class="st">"tagged"</span> <span class="kw">and</span> theme.is_core) <span class="kw">or</span> <span class="op">\</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>                   (filter_type <span class="op">==</span> <span class="st">"untagged"</span> <span class="kw">and</span> <span class="kw">not</span> theme.is_core):</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>                    themes.append(theme)</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> themes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L654" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator">PipelineOrchestrator</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator (report_id:str, hdgs:dict,
                       eval_data:evaluatr.frameworks.EvalData,
                       cfg:fastcore.basics.AttrDict)</code></pre>
</blockquote>
<p><em>The orchestrator of the pipeline</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>report_id</td>
<td>str</td>
<td>The report identifier</td>
</tr>
<tr class="even">
<td>hdgs</td>
<td>dict</td>
<td>The heading dictionary</td>
</tr>
<tr class="odd">
<td>eval_data</td>
<td>EvalData</td>
<td>The evaluation data</td>
</tr>
<tr class="even">
<td>cfg</td>
<td>AttrDict</td>
<td>The configuration</td>
</tr>
</tbody>
</table>
<div id="cell-113" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>cfg.pipeline <span class="op">=</span> AttrDict({</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'select_section_prompt'</span>: select_section_sp,</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tagging_prompt'</span>: tagging_sp_no_citation,</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'model'</span>: <span class="st">'claude-sonnet-4-5'</span>,</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cache_system'</span>: <span class="va">True</span>,</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cache_theme'</span>: <span class="va">True</span>,</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'response_format'</span>: TagResult,</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'verbosity'</span>: <span class="dv">2</span>,</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'call_delay'</span>: <span class="dv">1</span>,</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'force_refresh'</span>: AttrDict({</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sections'</span>: <span class="va">False</span>,</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'stage1'</span>: <span class="va">False</span>,</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'stage2'</span>: <span class="va">False</span>,</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'stage3'</span>: <span class="va">False</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-114" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PipelineOrchestrator:</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"The orchestrator of the pipeline"</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>                 report_id: <span class="bu">str</span>,  <span class="co"># The report identifier</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>                 hdgs: <span class="bu">dict</span>,  <span class="co"># The heading dictionary</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>                 eval_data: EvalData,  <span class="co"># The evaluation data</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>                 cfg: AttrDict  <span class="co"># The configuration</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cfg_p <span class="op">=</span> cfg.pipeline</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>        store_attr()</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        setup_trace_logging(report_id, <span class="va">self</span>.cfg_p.verbosity)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> PipelineResults()</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.core_sections <span class="op">=</span> <span class="va">None</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.doc_content <span class="op">=</span> <span class="va">None</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L671" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator.identify_sections" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator.identify_sections">PipelineOrchestrator.identify_sections</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator.identify_sections (semaphore)</code></pre>
</blockquote>
<p><em>Identify core sections and log the selection</em></p>
<div id="cell-116" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> identify_sections(<span class="va">self</span>:PipelineOrchestrator, semaphore):</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Identify core sections and log the selection"</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.cfg_p.force_refresh.sections:</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>        cached <span class="op">=</span> get_from_cache(sections_cache, <span class="va">self</span>.report_id)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cached:</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.core_sections <span class="op">=</span> json.loads(cached.sections_selected)</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.doc_content <span class="op">=</span> extract_core_content(<span class="va">self</span>.core_sections, <span class="va">self</span>.hdgs)</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>            log_analysis_event(</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sections_retrieved_from_cache"</span>,</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.report_id,</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>                sections_selected<span class="op">=</span><span class="va">self</span>.core_sections)</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>    core_sections_result <span class="op">=</span> <span class="cf">await</span> limit(</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>        semaphore,</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>        identify_core_sections(<span class="va">self</span>.hdgs, <span class="va">self</span>.cfg_p.select_section_prompt, <span class="va">self</span>.cfg_p.model),</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cfg_p.call_delay</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.core_sections <span class="op">=</span> core_sections_result[<span class="st">'section_names'</span>]</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.doc_content <span class="op">=</span> extract_core_content(<span class="va">self</span>.core_sections, <span class="va">self</span>.hdgs)</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>    store_in_cache(sections_cache, {</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'report_id'</span>: <span class="va">self</span>.report_id,</span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sections_selected'</span>: json.dumps(<span class="va">self</span>.core_sections),</span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reasoning'</span>: core_sections_result[<span class="st">'reasoning'</span>]</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>    log_analysis_event(</span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sections_identified"</span>,</span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.report_id,</span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>        sections_selected<span class="op">=</span><span class="va">self</span>.core_sections,</span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a>        reasoning<span class="op">=</span>core_sections_result[<span class="st">'reasoning'</span>]</span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L719" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator.process_themes_batch" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator.process_themes_batch">PipelineOrchestrator.process_themes_batch</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator.process_themes_batch (themes, semaphore, stage,
                                            force_refresh, log_fn=None)</code></pre>
</blockquote>
<p><em>Process multiple themes in parallel with rate limiting and caching</em></p>
<div id="cell-118" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _tag_kwargs(<span class="va">self</span>:PipelineOrchestrator):</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'system_prompt'</span>: <span class="va">self</span>.cfg_p.tagging_prompt,</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'response_format'</span>: <span class="va">self</span>.cfg_p.response_format,</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model'</span>: <span class="va">self</span>.cfg_p.model,</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cache_system'</span>: <span class="va">self</span>.cfg_p.cache_system,</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cache_theme'</span>: <span class="va">self</span>.cfg_p.cache_theme</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-119" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> process_themes_batch(<span class="va">self</span>:PipelineOrchestrator, </span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>                               themes, </span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>                               semaphore, </span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>                               stage, </span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>                               force_refresh,</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>                               log_fn<span class="op">=</span><span class="va">None</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>                               ):</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Process multiple themes in parallel with rate limiting and caching"</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> process_one(theme, framework_info):</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check cache first (unless force_refresh)</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> force_refresh:</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>            pk <span class="op">=</span> (<span class="va">self</span>.report_id, <span class="bu">str</span>(stage), <span class="bu">str</span>(framework_info.name), </span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">str</span>(framework_info.category), <span class="bu">str</span>(framework_info.theme_id))</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>            cached <span class="op">=</span> get_from_cache(theme_cache, pk)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> cached:</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> TaggingResult(</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>                    {<span class="st">'is_core'</span>: cached.is_core, <span class="st">'reasoning'</span>: cached.reasoning, </span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'confidence'</span>: cached.confidence}, </span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>                    framework_info</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> log_fn: </span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>                    log_analysis_event(<span class="st">"theme_retrieved_from_cache"</span>, <span class="va">self</span>.report_id, </span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>                                     stage<span class="op">=</span>stage, framework_info<span class="op">=</span>framework_info)</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> result</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cache miss - call LLM</span></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> tag_theme(</span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>            doc_content<span class="op">=</span><span class="va">self</span>.doc_content,</span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>            theme<span class="op">=</span>theme,</span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span><span class="va">self</span>._tag_kwargs()</span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>        parsed <span class="op">=</span> parse_response(response)</span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> TaggingResult(parsed, framework_info)</span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store in cache</span></span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>        store_in_cache(theme_cache, {</span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">'report_id'</span>: <span class="va">self</span>.report_id,</span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">'stage'</span>: <span class="bu">str</span>(stage),</span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'framework'</span>: <span class="bu">str</span>(framework_info.name),</span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">'framework_category'</span>: <span class="bu">str</span>(framework_info.category),</span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">'framework_theme_id'</span>: <span class="bu">str</span>(framework_info.theme_id),</span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">'is_core'</span>: result.is_core,</span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">'reasoning'</span>: result.reasoning,</span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">'confidence'</span>: result.confidence</span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> log_fn: log_fn(result, framework_info)</span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process with rate limiting</span></span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> [<span class="cf">await</span> limit(semaphore, process_one(<span class="op">*</span>themes[<span class="dv">0</span>]), <span class="va">self</span>.cfg_p.call_delay)]</span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a>    remaining <span class="op">=</span> <span class="cf">await</span> gather(<span class="op">*</span>[limit(semaphore, process_one(<span class="op">*</span>t), <span class="va">self</span>.cfg_p.call_delay) <span class="cf">for</span> t <span class="kw">in</span> themes[<span class="dv">1</span>:]])</span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a>    results.extend(remaining)</span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L779" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator.run_stage1" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator.run_stage1">PipelineOrchestrator.run_stage1</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator.run_stage1 (semaphore)</code></pre>
</blockquote>
<div id="cell-121" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run_stage1(<span class="va">self</span>:PipelineOrchestrator, semaphore):</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    themes <span class="op">=</span> []</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> <span class="va">self</span>.eval_data.srf_enablers:</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>        framework_info <span class="op">=</span> FrameworkInfo(Framework.SRF, FrameworkCat.ENABLERS, item.<span class="bu">id</span>)</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>        themes.append((format_enabler_theme(item), framework_info))</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> <span class="va">self</span>.eval_data.srf_crosscutting_priorities:</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>        framework_info <span class="op">=</span> FrameworkInfo(Framework.SRF, FrameworkCat.CROSSCUT, item.<span class="bu">id</span>)</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>        themes.append((format_crosscutting_theme(item), framework_info))</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    log_fn <span class="op">=</span> <span class="kw">lambda</span> result, finfo: log_analysis_event(</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"theme_tagged"</span>,</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.report_id,</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>        stage<span class="op">=</span>Stage.STAGE1,</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>        framework_info<span class="op">=</span>finfo,</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>        is_core<span class="op">=</span>result.is_core,</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>        reasoning<span class="op">=</span>result.reasoning,</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>        confidence<span class="op">=</span>result.confidence</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.process_themes_batch(</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>        themes<span class="op">=</span>themes, </span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>        semaphore<span class="op">=</span>semaphore, </span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>        stage<span class="op">=</span>Stage.STAGE1, </span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>        force_refresh<span class="op">=</span><span class="va">self</span>.cfg_p.force_refresh.stage1,</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>        log_fn<span class="op">=</span>log_fn</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> results:</span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results[Stage.STAGE1][result.framework_name][result.framework_category][result.framework_theme_id] <span class="op">=</span> result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-122" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>cfg.pipeline <span class="op">=</span> AttrDict({</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 'model': 'gemini/gemini-2.0-flash',</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'model'</span>: <span class="st">'claude-sonnet-4-5'</span>,</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tagging_prompt'</span>: tagging_sp_no_citation,</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'select_section_prompt'</span>: select_section_sp,</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'response_format'</span>: TagResult,</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cache_system'</span>: <span class="va">True</span>,</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cache_theme'</span>: <span class="va">True</span>,</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'verbosity'</span>: <span class="dv">2</span>,</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'call_delay'</span>: <span class="dv">1</span>,</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'force_refresh'</span>: AttrDict({</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sections'</span>: <span class="va">False</span>,</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'stage1'</span>: <span class="va">False</span>,</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'stage2'</span>: <span class="va">False</span>,</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'stage3'</span>: <span class="va">False</span></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>hdgs <span class="op">=</span> create_heading_dict(report)</span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>orchestrator <span class="op">=</span> PipelineOrchestrator(</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>    report_id<span class="op">=</span><span class="st">"49d2fba781b6a7c0d94577479636ee6f"</span>,</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>    hdgs<span class="op">=</span>hdgs,</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>    eval_data<span class="op">=</span>IOMEvalData(),</span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>    cfg<span class="op">=</span>cfg</span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>semaphore <span class="op">=</span> Semaphore(<span class="dv">2</span>)</span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> orchestrator.identify_sections(semaphore)</span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> orchestrator.run_stage1(semaphore)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>49d2fba781b6a7c0d94577479636ee6f - sections_retrieved_from_cache
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Enablers/1
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Enablers/2
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Enablers/3
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Enablers/4
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Enablers/5
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Enablers/6
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Enablers/7
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Crosscutting Priorities/1
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Crosscutting Priorities/2
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Crosscutting Priorities/3
49d2fba781b6a7c0d94577479636ee6f - stage1 - theme_retrieved_from_cache - SRF/Crosscutting Priorities/4</code></pre>
</div>
</div>
<div id="cell-123" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>tagged <span class="op">=</span> orchestrator.results(Stage.STAGE1, filter_type<span class="op">=</span><span class="st">'tagged'</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tagged themes: </span><span class="sc">{</span><span class="bu">len</span>(tagged)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total themes analyzed: </span><span class="sc">{</span><span class="bu">len</span>(orchestrator.results(Stage.STAGE1, filter_type<span class="op">=</span><span class="st">'all'</span>))<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Tagged themes: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Total themes analyzed: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>
</pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L813" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator.get_stage1_context" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator.get_stage1_context">PipelineOrchestrator.get_stage1_context</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator.get_stage1_context ()</code></pre>
</blockquote>
<p><em>Get formatted context from Stage 1 tagged themes</em></p>
<div id="cell-125" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_stage1_context(<span class="va">self</span>:PipelineOrchestrator) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get formatted context from Stage 1 tagged themes"</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    tagged_themes <span class="op">=</span> <span class="va">self</span>.results(Stage.STAGE1, filter_type<span class="op">=</span><span class="st">"tagged"</span>)</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> tagged_themes: </span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    context_parts <span class="op">=</span> []</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> theme <span class="kw">in</span> tagged_themes:</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> theme.framework_category <span class="op">==</span> <span class="bu">str</span>(FrameworkCat.ENABLERS):</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>            theme_data <span class="op">=</span> <span class="bu">next</span>(t <span class="cf">for</span> t <span class="kw">in</span> <span class="va">self</span>.eval_data.srf_enablers </span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> t.<span class="bu">id</span> <span class="op">==</span> theme.framework_theme_id)</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> theme.framework_category <span class="op">==</span> <span class="bu">str</span>(FrameworkCat.CROSSCUT):</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>            theme_data <span class="op">=</span> <span class="bu">next</span>(t <span class="cf">for</span> t <span class="kw">in</span> <span class="va">self</span>.eval_data.srf_crosscutting_priorities </span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> t.<span class="bu">id</span> <span class="op">==</span> theme.framework_theme_id)</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>        context_parts.append(<span class="ss">f"- **</span><span class="sc">{</span>theme<span class="sc">.</span>framework_category<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>theme_data<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">**: </span><span class="sc">{</span>theme_data<span class="sc">.</span>title<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"### Report Preliminary Context</span><span class="ch">\n</span><span class="ss">This evaluation report covers the following Strategic Results Framework themes:</span><span class="ch">\n</span><span class="ss">"</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(context_parts)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For instance:</p>
<div id="cell-127" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(orchestrator.get_stage1_context())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">### Report Preliminary Context
This evaluation report covers the following Strategic Results Framework themes:
- **Enablers <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>**: Partnership
- **Enablers <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>**: Data and evidence
- **Enablers <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>**: Learning and Innovation
- **Crosscutting Priorities <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>**: Protection-centred
</pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L835" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator.run_stage2" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator.run_stage2">PipelineOrchestrator.run_stage2</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator.run_stage2 (semaphore)</code></pre>
</blockquote>
<p><em>Run stage 2 - GCM objectives analysis with Stage 1 context</em></p>
<div id="cell-129" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run_stage2(<span class="va">self</span>:PipelineOrchestrator, semaphore):</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Run stage 2 - GCM objectives analysis with Stage 1 context"</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    stage1_context <span class="op">=</span> <span class="va">self</span>.get_stage1_context()</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    themes <span class="op">=</span> []</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> gcm_obj <span class="kw">in</span> <span class="va">self</span>.eval_data.gcm_objectives_small:</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>        framework_info <span class="op">=</span> FrameworkInfo(Framework.GCM, FrameworkCat.OBJS, gcm_obj[<span class="st">"id"</span>])</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>        theme <span class="op">=</span> format_gcm_theme(gcm_obj) <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span> <span class="op">+</span> stage1_context</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>        themes.append((theme, framework_info))</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    log_fn <span class="op">=</span> <span class="kw">lambda</span> result, finfo: log_analysis_event(</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"theme_tagged"</span>,</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.report_id,</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>        stage<span class="op">=</span>Stage.STAGE2,</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>        framework_info<span class="op">=</span>finfo,</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>        is_core<span class="op">=</span>result.is_core,</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>        reasoning<span class="op">=</span>result.reasoning,</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>        confidence<span class="op">=</span>result.confidence</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.process_themes_batch(</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>        themes<span class="op">=</span>themes,</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>        semaphore<span class="op">=</span>semaphore,</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>        stage<span class="op">=</span>Stage.STAGE2,</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>        force_refresh<span class="op">=</span><span class="va">self</span>.cfg_p.force_refresh.stage2,</span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>        log_fn<span class="op">=</span>log_fn</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> results: </span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results[Stage.STAGE2][result.framework_name][result.framework_category][result.framework_theme_id] <span class="op">=</span> result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-130" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> orchestrator.run_stage2(semaphore)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/1
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/2
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/3
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/5
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/4
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/6
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/7
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/8
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/9
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/10
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/11
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/13
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/12
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/15
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/14
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/16
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/17
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/19
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/18
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/20
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/21
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/22
49d2fba781b6a7c0d94577479636ee6f - stage2 - theme_tagged - GCM/Objectives/23</code></pre>
</div>
</div>
<div id="cell-131" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>tagged <span class="op">=</span> orchestrator.results(Stage.STAGE2, filter_type<span class="op">=</span><span class="st">"tagged"</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Covered themes: </span><span class="sc">{</span><span class="bu">len</span>(tagged)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total themes analyzed: </span><span class="sc">{</span><span class="bu">len</span>(orchestrator.results(Stage.STAGE2, filter_type<span class="op">=</span><span class="st">'all'</span>))<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Covered themes: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Total themes analyzed: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>
</pre>
</div>
</div>
</section>
<section id="filtering-out-srf-outputs" class="level3">
<h3 class="anchored" data-anchor-id="filtering-out-srf-outputs">Filtering out SRF outputs</h3>
<div id="cell-133" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>eval_data.gcm_srf_lut[<span class="st">'23'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['3c42', '3c52']</code></pre>
</div>
</div>
<div id="cell-134" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>gcm_ids <span class="op">=</span> <span class="bu">list</span>(eval_data.gcm_srf_lut.keys())</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>srf_counts <span class="op">=</span> [<span class="bu">len</span>(srf_outputs) <span class="cf">for</span> srf_outputs <span class="kw">in</span> eval_data.gcm_srf_lut.values()]</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>))</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>plt.bar(gcm_ids, srf_counts, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'GCM Objective'</span>)</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Number of SRF Outputs'</span>)</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Number of SRF Outputs per GCM Objective'</span>)</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_mappr_files/figure-html/cell-109-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L868" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_filtered_srf_output_ids" class="level3">
<h3 class="anchored" data-anchor-id="get_filtered_srf_output_ids">get_filtered_srf_output_ids</h3>
<blockquote class="blockquote">
<pre><code> get_filtered_srf_output_ids (results:__main__.PipelineResults,
                              eval_data:evaluatr.frameworks.EvalData)</code></pre>
</blockquote>
<p><em>Get filtered SRF output IDs based on covered GCM themes.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>results</td>
<td>PipelineResults</td>
<td>PipelineResults</td>
</tr>
<tr class="even">
<td>eval_data</td>
<td>EvalData</td>
<td>EvalData</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>list</strong></td>
<td><strong>list of SRF output IDs</strong></td>
</tr>
</tbody>
</table>
<div id="cell-136" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_filtered_srf_output_ids(</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    results: PipelineResults, <span class="co"># PipelineResults</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    eval_data: EvalData <span class="co"># EvalData</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">list</span>: <span class="co"># list of SRF output IDs</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get filtered SRF output IDs based on covered GCM themes."</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    covered_gcm <span class="op">=</span> results(Stage.STAGE2, filter_type<span class="op">=</span><span class="st">"tagged"</span>)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>    srf_output_ids <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> gcm_theme <span class="kw">in</span> covered_gcm:</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>        gcm_id <span class="op">=</span> gcm_theme.framework_theme_id</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gcm_id <span class="kw">in</span> eval_data.gcm_srf_lut:</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>            srf_output_ids.update(eval_data.gcm_srf_lut[gcm_id])</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(srf_output_ids)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[65]</span><span class="ansi-green-fg">, line 3</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#| exports</span>
<span class="ansi-green-fg">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg">get_filtered_srf_output_ids</span>(
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">3</span>     results: <span class="ansi-yellow-bg">PipelineResults</span>, <span style="font-style:italic;color:rgb(95,135,135)"># PipelineResults</span>
<span class="ansi-green-fg">      4</span>     eval_data: EvalData <span style="font-style:italic;color:rgb(95,135,135)"># EvalData</span>
<span class="ansi-green-fg">      5</span>     ) -&gt; <span style="color:rgb(0,135,0)">list</span>: <span style="font-style:italic;color:rgb(95,135,135)"># list of SRF output IDs</span>
<span class="ansi-green-fg">      6</span>     <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Get filtered SRF output IDs based on covered GCM themes.</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">      7</span>     covered_gcm = results(Stage.STAGE2, filter_type=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">tagged</span><span class="ansi-yellow-fg">"</span>)

<span class="ansi-red-fg">NameError</span>: name 'PipelineResults' is not defined</pre>
</div>
</div>
</div>
<p>For instance:</p>
<div id="cell-138" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>filtered_srfs <span class="op">=</span> get_filtered_srf_output_ids(orchestrator.results, eval_data)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'nb. of filtered srf outputs: </span><span class="sc">{</span><span class="bu">len</span>(filtered_srfs)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'first 5: </span><span class="sc">{</span>filtered_srfs[:<span class="dv">5</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[42]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#| eval: false</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> filtered_srfs = <span class="ansi-yellow-bg">get_filtered_srf_output_ids</span>(orchestrator.results, eval_data)
<span class="ansi-green-fg">      4</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">nb. of filtered srf outputs: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">len</span>(filtered_srfs)<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">'</span>)
<span class="ansi-green-fg">      5</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">first 5: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>filtered_srfs[:<span class="ansi-green-fg">5</span>]<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">'</span>)

<span class="ansi-red-fg">NameError</span>: name 'get_filtered_srf_output_ids' is not defined</pre>
</div>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L885" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator.get_combined_context" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator.get_combined_context">PipelineOrchestrator.get_combined_context</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator.get_combined_context ()</code></pre>
</blockquote>
<p><em>Get combined context from Stage 1 and Stage 2 tagged themes</em></p>
<div id="cell-140" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_combined_context(<span class="va">self</span>:PipelineOrchestrator) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get combined context from Stage 1 and Stage 2 tagged themes"</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    stage1_context <span class="op">=</span> <span class="va">self</span>.get_stage1_context()</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    tagged_gcm <span class="op">=</span> <span class="va">self</span>.results(Stage.STAGE2, filter_type<span class="op">=</span><span class="st">"tagged"</span>)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> tagged_gcm:</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> stage1_context</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>    gcm_context <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"- **GCM </span><span class="sc">{</span>theme<span class="sc">.</span>framework_theme_id<span class="sc">}</span><span class="ss">**: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>eval_data<span class="sc">.</span>gcm_objectives_small[<span class="bu">int</span>(theme.framework_theme_id)<span class="op">-</span><span class="dv">1</span>][<span class="st">'title'</span>]<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> theme <span class="kw">in</span> tagged_gcm</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>stage1_context<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">### Covered GCM Objectives</span><span class="ch">\n</span><span class="sc">{</span>gcm_context<span class="sc">}</span><span class="ss">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For instance:</p>
<div id="cell-142" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(orchestrator.get_combined_context())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">### Report Preliminary Context
This evaluation report covers the following Strategic Results Framework themes:
- **Enablers <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>**: Partnership
- **Enablers <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>**: Data and evidence
- **Enablers <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>**: Learning and Innovation
- **Crosscutting Priorities <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>**: Protection-centred

### Covered GCM Objectives
- **GCM <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>**: Collect and utilize accurate and disaggregated data as a basis for evidence-based policies
- **GCM <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>**: Address and reduce vulnerabilities in migration
- **GCM <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>**: Strengthen certainty and predictability in migration procedures for appropriate screening, assessment
and referral
- **GCM <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>**: Empower migrants and societies to realize full inclusion and social cohesion
- **GCM <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21</span>**: Cooperate in facilitating safe and dignified return and readmission, as well as sustainable 
reintegration
- **GCM <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>**: Strengthen international cooperation and global partnerships for safe, orderly and regular migration
</pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L902" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator.get_filtered_srf_outputs" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator.get_filtered_srf_outputs">PipelineOrchestrator.get_filtered_srf_outputs</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator.get_filtered_srf_outputs ()</code></pre>
</blockquote>
<p><em>Get filtered SRF output IDs based on tagged GCM themes</em></p>
<div id="cell-144" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_filtered_srf_outputs(<span class="va">self</span>:PipelineOrchestrator) <span class="op">-&gt;</span> <span class="bu">list</span>:</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get filtered SRF output IDs based on tagged GCM themes"</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    tagged_gcm <span class="op">=</span> <span class="va">self</span>.results(Stage.STAGE2, filter_type<span class="op">=</span><span class="st">"tagged"</span>)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    srf_output_ids <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> gcm_theme <span class="kw">in</span> tagged_gcm:</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>        gcm_id <span class="op">=</span> gcm_theme.framework_theme_id</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gcm_id <span class="kw">in</span> <span class="va">self</span>.eval_data.gcm_srf_lut:</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>            srf_output_ids.update(<span class="va">self</span>.eval_data.gcm_srf_lut[gcm_id])</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(srf_output_ids)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-145" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>orchestrator.get_filtered_srf_outputs()[:<span class="dv">5</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['1a11', '2c11', '1a16', '3c13', '3c43']</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L916" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pipelineorchestrator.run_stage3" class="level3">
<h3 class="anchored" data-anchor-id="pipelineorchestrator.run_stage3">PipelineOrchestrator.run_stage3</h3>
<blockquote class="blockquote">
<pre><code> PipelineOrchestrator.run_stage3 (semaphore)</code></pre>
</blockquote>
<p><em>Run stage 3 - Targeted SRF outputs analysis with combined context</em></p>
<div id="cell-147" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run_stage3(<span class="va">self</span>:PipelineOrchestrator, semaphore):</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Run stage 3 - Targeted SRF outputs analysis with combined context"</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    combined_context <span class="op">=</span> <span class="va">self</span>.get_combined_context()</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    filtered_output_ids <span class="op">=</span> <span class="va">self</span>.get_filtered_srf_outputs()</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    themes <span class="op">=</span> []</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> output_id <span class="kw">in</span> filtered_output_ids:</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>        output_context <span class="op">=</span> find_srf_output_by_id(<span class="va">self</span>.eval_data, output_id)</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> output_context:</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>            framework_info <span class="op">=</span> FrameworkInfo(Framework.SRF, FrameworkCat.OUTPUTS, output_id)</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>            theme <span class="op">=</span> format_srf_output(output_context) <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span> <span class="op">+</span> combined_context</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>            themes.append((theme, framework_info))</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    log_fn <span class="op">=</span> <span class="kw">lambda</span> result, finfo: log_analysis_event(</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"theme_tagged"</span>,</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.report_id,</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>        stage<span class="op">=</span>Stage.STAGE3,</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>        framework_info<span class="op">=</span>finfo,</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>        is_core<span class="op">=</span>result.is_core,</span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>        reasoning<span class="op">=</span>result.reasoning,</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>        confidence<span class="op">=</span>result.confidence</span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.process_themes_batch(</span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>        themes<span class="op">=</span>themes,</span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>        semaphore<span class="op">=</span>semaphore,</span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>        stage<span class="op">=</span>Stage.STAGE3,</span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true" tabindex="-1"></a>        force_refresh<span class="op">=</span><span class="va">self</span>.cfg_p.force_refresh.stage3,</span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true" tabindex="-1"></a>        log_fn<span class="op">=</span>log_fn</span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb124-32"><a href="#cb124-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-33"><a href="#cb124-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> results: </span>
<span id="cb124-34"><a href="#cb124-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results[Stage.STAGE3][result.framework_name][result.framework_category][result.framework_theme_id] <span class="op">=</span> result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-148" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> orchestrator.run_stage3(semaphore)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a11
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a16
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2c11
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c43
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c13
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1c21
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c42
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a21
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a17
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c31
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3d35
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3d44
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c21
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c41
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3d42
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1b32
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b31
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3b31
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b22
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3a42
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b63
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b32
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b21
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3d34
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3a52
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2c12
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2a21
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b12
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b42
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1c22
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a12
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b43
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b53
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1b22
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3d31
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c52
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a19
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1c23
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b13
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1c11
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1b11
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b11
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c51
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b54
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b62
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3a41
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a32
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c22
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/2b52
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1b33
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a22
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3a44
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c15
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1a31
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3b22
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3c32
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3a51
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3d33
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1b21
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/1b12
49d2fba781b6a7c0d94577479636ee6f - stage3 - theme_tagged - SRF/Outputs/3a43</code></pre>
</div>
</div>
<div id="cell-149" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>n_outputs <span class="op">=</span> <span class="bu">len</span>(orchestrator.results(Stage.STAGE3, filter_type<span class="op">=</span><span class="st">"tagged"</span>))</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of outputs: </span><span class="sc">{</span>n_outputs<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Number of outputs: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40</span>
</pre>
</div>
</div>
</section>
</section>
<section id="cli" class="level2">
<h2 class="anchored" data-anchor-id="cli">CLI</h2>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L952" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="find_enriched_path" class="level3">
<h3 class="anchored" data-anchor-id="find_enriched_path">find_enriched_path</h3>
<blockquote class="blockquote">
<pre><code> find_enriched_path (eval_id:str, md_dir:str)</code></pre>
</blockquote>
<p><em>Find the enriched markdown directory for an evaluation</em></p>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L969" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="parse_force_refresh" class="level3">
<h3 class="anchored" data-anchor-id="parse_force_refresh">parse_force_refresh</h3>
<blockquote class="blockquote">
<pre><code> parse_force_refresh (force_refresh_str:str, working_cfg)</code></pre>
</blockquote>
<p><em>Parse and apply force_refresh parameter to config</em></p>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L980" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="run_selected_stages" class="level3">
<h3 class="anchored" data-anchor-id="run_selected_stages">run_selected_stages</h3>
<blockquote class="blockquote">
<pre><code> run_selected_stages (orchestrator, semaphore, stages_to_run)</code></pre>
</blockquote>
<p><em>Run only the selected pipeline stages</em></p>
<hr>
<p><a href="https://github.com/franckalbinet/evaluatr/blob/main/evaluatr/mappr.py#L992" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="tag_evaluation" class="level3">
<h3 class="anchored" data-anchor-id="tag_evaluation">tag_evaluation</h3>
<blockquote class="blockquote">
<pre><code> tag_evaluation (eval_id:str, md_dir:str='_data/md_library',
                 stages:str='1,2,3', force_refresh:str=None)</code></pre>
</blockquote>
<p><em>Tag evaluation report against frameworks</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>eval_id</td>
<td>str</td>
<td></td>
<td>Evaluation ID to process</td>
</tr>
<tr class="even">
<td>md_dir</td>
<td>str</td>
<td>_data/md_library</td>
<td>Markdown directory</td>
</tr>
<tr class="odd">
<td>stages</td>
<td>str</td>
<td>1,2,3</td>
<td>Stages to run (comma-separated: 1,2,3)</td>
</tr>
<tr class="even">
<td>force_refresh</td>
<td>str</td>
<td>None</td>
<td>Force refresh stages (comma-separated: sections,stage1,stage2,stage3)</td>
</tr>
</tbody>
</table>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/franckalbinet\.github\.io\/evaluatr");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/franckalbinet/evaluatr/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>